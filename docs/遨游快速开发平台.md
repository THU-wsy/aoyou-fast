# 第01章_项目介绍及搭建

## 1. 前后端分离

前后端分离主要目的是**解耦**，核心思想是：前端Html页面通过Ajax调用后端的 RestFul API 并使用Json数据进行数据交互。

- 前端项目部署到**Web服务器**上：Web服务器一般只能解析静态资源如html、css、图片、文档等，一般性能较强，常用的有Nginx
- 后端项目部署到**应用服务器**上：应用服务器可以解析动态资源和静态资源，解析静态资源的性能没有Web服务器好，常用的有Tomcat

一般来说Web服务器暴露在公网上，而应用服务器只允许内网访问，前端向后端发送的http请求会通过Web服务器代理到对应的后端服务接口上。

## 2. 搭建后端项目

### 2.1 创建父工程

创建一个新的Maven项目作为父工程，然后删除src目录。父工程只用于管理依赖版本，在pom文件中添加：

```xml
<groupId>com.thuwsy.aoyou</groupId>
<artifactId>aoyou-fast</artifactId>
<version>1.0.0</version>
<description>父工程，用于管理依赖版本</description>

<properties>
    <maven.compiler.source>17</maven.compiler.source>
    <maven.compiler.target>17</maven.compiler.target>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <aoyou.version>1.0.0</aoyou.version>
    <springboot.version>3.1.5</springboot.version>
    <druid.version>1.2.20</druid.version>
    <fastjson2.version>2.0.39</fastjson2.version>
    <springdoc.version>2.1.0</springdoc.version>
    <mybatis-plus.version>3.5.3.2</mybatis-plus.version>
    <jwt.version>4.4.0</jwt.version>
    <hutool.version>5.8.22</hutool.version>
</properties>

<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-dependencies</artifactId>
            <version>${springboot.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid-spring-boot-starter</artifactId>
            <version>${druid.version}</version>
        </dependency>
        <dependency>
            <groupId>com.alibaba.fastjson2</groupId>
            <artifactId>fastjson2</artifactId>
            <version>${fastjson2.version}</version>
        </dependency>
        <dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
            <version>${springdoc.version}</version>
        </dependency>
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>${mybatis-plus.version}</version>
        </dependency>
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-generator</artifactId>
            <version>${mybatis-plus.version}</version>
        </dependency>
        <dependency>
            <groupId>com.auth0</groupId>
            <artifactId>java-jwt</artifactId>
            <version>${jwt.version}</version>
        </dependency>
        <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
            <version>${hutool.version}</version>
        </dependency>
    </dependencies>
</dependencyManagement>
```

### 2.2 创建子模块

- `aoyou-common`：定义一些公用的类、工具类等，以及引入通用的依赖
- `aoyou-support`：定义项目中的核心配置，如MyBatis-Plus、Spring Security的配置类等
- `aoyou-starter`：定义项目的入口
- 业务模块：如`aoyou-auth`（认证模块）、`aoyou-user`（用户操作模块）

然后在父工程pom文件中添加这些模块的版本管理（starter模块不需要）：

```xml
<dependency>
    <groupId>com.thuwsy.aoyou</groupId>
    <artifactId>aoyou-common</artifactId>
    <version>${aoyou.version}</version>
</dependency>
<dependency>
    <groupId>com.thuwsy.aoyou</groupId>
    <artifactId>aoyou-support</artifactId>
    <version>${aoyou.version}</version>
</dependency>
<dependency>
    <groupId>com.thuwsy.aoyou</groupId>
    <artifactId>aoyou-auth</artifactId>
    <version>${aoyou.version}</version>
</dependency>
<dependency>
    <groupId>com.thuwsy.aoyou</groupId>
    <artifactId>aoyou-user</artifactId>
    <version>${aoyou.version}</version>
</dependency>
```

### 2.3 模块间的依赖关系

- support模块：依赖common模块
- 业务模块：依赖support模块
- starter模块：依赖各个业务模块

所以需要在各个模块中添加依赖，实现上述依赖关系。

注意：需要在common模块中引入web依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
```

然后在starter模块中创建主启动类：

```java
// 包名为com.thuwsy.aoyou
@SpringBootApplication
public class AoyouApplication {
    public static void main(String[] args) {
        SpringApplication.run(AoyouApplication.class, args);
    }
}
```

## 3. 搭建前端项目

```powershell
# 1.创建命令
npm create vue@3.4.1

# 2.具体配置
## 配置项目名称
Project name: aoyou-admin-ui
## 是否添加TypeScript支持
Add TypeScript?  Yes
## 是否添加JSX支持
Add JSX Support?  No
## 是否添加路由环境
Add Vue Router for Single Page Application development?  Yes
## 是否添加pinia环境
Add Pinia for state management?  Yes
## 是否添加单元测试
Add Vitest for Unit Testing?  No
## 是否添加端到端测试方案
Add an End-to-End Testing Solution? » No
## 是否添加ESLint语法检查
Add ESLint for code quality?  No
## 是否添加Prettiert代码格式化
Add Prettier for code formatting?  No
```

```powershell
# 安装依赖
npm install
# 启动项目
npm run dev
# 构建项目
npm run build
```

## 4. 上传git仓库

![image-20240220130102350](images/image-20240220130102350.png)

修改`.gitignore`，来忽略一些文件：

```
HELP.md
target/
!.mvn/wrapper/maven-wrapper.jar
!**/src/main/**/target/
!**/src/test/**/target/

### STS ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache

### IntelliJ IDEA ###
.idea
*.iws
*.iml
*.ipr
**/mvnw
**/mvnw.cmd
**/.mvn
**/target/
**/.gitignore

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/
build/
!**/src/main/**/build/
!**/src/test/**/build/
logs/

### VS Code ###
.vscode/
package-lock.json
```

## 5. 环境搭建

> 注意：如果Docker拉取镜像时域名解析失败，可以将`vi /etc/resolv.conf`中改为`nameserver 8.8.8.8`

Linux虚拟机上：

（1）安装docker，版本24.0.7

（2）使用docker安装mysql:8.0.27

（3）使用docker安装redis:7.2.0



# 第02章_创建基本模块

## 1. common模块

### 1.1 创建数据库表

连接到MySQL后，执行sql脚本：

```sql
CREATE DATABASE `aoyou_fast` DEFAULT CHARACTER SET utf8mb4;
USE `aoyou_fast`;
# 然后执行脚本aoyou_fast.sql
```

### 1.2 创建实体类

首先要在common模块引入依赖：

```xml
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
</dependency>
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
</dependency>
```

然后在common模块中创建实体类（包名`com.thuwsy.aoyou.common.domain.entity`）

```java
@Data
@TableName("ums_sys_user")
public class UmsSysUser implements Serializable {
    @TableId
    private Long id;
    private String username;
    private String nickname;
    private String email;
    private String mobile;
    private Integer sex;
    private String avatar;
    private String password;
    private Integer status;
    private String creator;
    private LocalDateTime createTime;
    private String updater;
    private LocalDateTime updateTime;
    private String remark;
    @TableLogic
    private Integer deleted;
}
```

```java
@Data
@TableName("ums_role")
public class UmsRole implements Serializable {
    @TableId
    private Long roleId;
    private String roleLabel;
    private String roleName;
    private Integer sort;
    private Integer status;
    private String creator;
    private LocalDateTime createTime;
    private String updater;
    private LocalDateTime updateTime;
    private String remark;
    @TableLogic
    private Integer deleted;
}
```

```java
@Data
@TableName("ums_menu")
public class UmsMenu implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long id;
    private Long parentId;
    private String menuName;
    private Integer sort;
    private Integer menuType;
    private String path;
    private String componentPath;
    private String perms;
    private String icon;
    private Integer status;
    private String creator;
    private LocalDateTime createTime;
    private String updater;
    private LocalDateTime updateTime;
    private String remark;
    @TableLogic
    private Integer deleted;
}
```

### 1.3 创建对应的mapper和service

- 包名`com.thuwsy.aoyou.common.mapper`

```java
@Mapper
public interface UmsSysUserMapper extends BaseMapper<UmsSysUser> {
}
```

```java
@Mapper
public interface UmsRoleMapper extends BaseMapper<UmsRole> {
}
```

```java
@Mapper
public interface UmsMenuMapper extends BaseMapper<UmsMenu> {
}
```

- 包名`com.thuwsy.aoyou.common.service`

```java
public interface IUmsSysUserService {
}
```

```java
public interface IUmsRoleService {
}
```

```java
public interface IUmsMenuService {
}
```

- 包名`com.thuwsy.aoyou.common.service.impl`

```java
@Service
public class UmsSysUserServiceImpl implements IUmsSysUserService {
}
```

```java
@Service
public class UmsRoleServiceImpl implements IUmsRoleService {
}
```

```java
@Service
public class UmsMenuServiceImpl implements IUmsMenuService {
}
```

### 1.4 定义响应码

包名`com.thuwsy.aoyou.common.constants`

```java
public class HttpStatus {
    /**
     * 操作成功
     */
    public static final int SUCCESS = 200;

    /**
     * 对象创建成功
     */
    public static final int CREATED = 201;

    /**
     * 请求已经被接受
     */
    public static final int ACCEPTED = 202;

    /**
     * 操作已经执行成功，但是没有返回数据
     */
    public static final int NO_CONTENT = 204;

    /**
     * 资源已被移除
     */
    public static final int MOVED_PERM = 301;

    /**
     * 重定向
     */
    public static final int SEE_OTHER = 303;

    /**
     * 资源没有被修改
     */
    public static final int NOT_MODIFIED = 304;

    /**
     * 参数列表错误（缺少，格式不匹配）
     */
    public static final int BAD_REQUEST = 400;

    /**
     * 未认证
     */
    public static final int UNAUTHORIZED = 401;

    /**
     * 权限不足，禁止访问
     */
    public static final int FORBIDDEN = 403;

    /**
     * 资源，服务未找到
     */
    public static final int NOT_FOUND = 404;

    /**
     * 不允许的http方法
     */
    public static final int BAD_METHOD = 405;

    /**
     * 资源冲突，或者资源被锁
     */
    public static final int CONFLICT = 409;

    /**
     * 不支持的数据，媒体类型
     */
    public static final int UNSUPPORTED_TYPE = 415;

    /**
     * 系统内部错误
     */
    public static final int ERROR = 500;

    /**
     * 接口未实现
     */
    public static final int NOT_IMPLEMENTED = 501;

    /**
     * 系统警告消息
     */
    public static final int WARN = 601;
}
```

### 1.5 统一返回结果集

首先引入依赖：

```xml
<dependency>
    <groupId>cn.hutool</groupId>
    <artifactId>hutool-all</artifactId>
</dependency>
```

包名`com.thuwsy.aoyou.common.response`

```java
public class CommonResult extends HashMap<String,Object> {

    private static final long serialVersionUID = 1L;

    /**
     * 状态码
     */
    public static final String CODE_TAG = "code";

    /**
     * 返回内容
     */
    public static final String MSG_TAG = "msg";

    /**
     * 数据对象
     */
    public static final String DATA_TAG = "data";

    /**
     * 初始化一个新创建的 CommonResult 对象，使其表示一个空消息。
     */
    public CommonResult() {}

    /**
     * 初始化一个新创建的 CommonResult 对象
     *
     * @param code 状态码
     * @param msg  返回内容
     */
    public CommonResult(int code, String msg) {
        super.put(CODE_TAG, code);
        super.put(MSG_TAG, msg);
    }

    /**
     * 初始化一个新创建的 CommonResult 对象
     *
     * @param code 状态码
     * @param msg  返回内容
     * @param data 数据对象
     */
    public CommonResult(int code, String msg, Object data) {
        super.put(CODE_TAG, code);
        super.put(MSG_TAG, msg);
        if (ObjectUtil.isNotNull(data)) {
            super.put(DATA_TAG, data);
        }
    }

    /**
     * 返回成功消息
     *
     * @return 成功消息
     */
    public static CommonResult success() {
        return CommonResult.success("操作成功");
    }

    /**
     * 返回成功数据
     *
     * @return 成功消息
     */
    public static CommonResult success(Object data) {
        return CommonResult.success("操作成功", data);
    }

    /**
     * 返回成功消息
     *
     * @param msg 返回内容
     * @return 成功消息
     */
    public static CommonResult success(String msg) {
        return CommonResult.success(msg, null);
    }

    /**
     * 返回成功消息
     *
     * @param msg  返回内容
     * @param data 数据对象
     * @return 成功消息
     */
    public static CommonResult success(String msg, Object data) {
        return new CommonResult(HttpStatus.SUCCESS, msg, data);
    }

    /**
     * 返回警告消息
     *
     * @param msg 返回内容
     * @return 警告消息
     */
    public static CommonResult warn(String msg) {
        return CommonResult.warn(msg, null);
    }

    /**
     * 返回警告消息
     *
     * @param msg  返回内容
     * @param data 数据对象
     * @return 警告消息
     */
    public static CommonResult warn(String msg, Object data) {
        return new CommonResult(HttpStatus.WARN, msg, data);
    }

    /**
     * 返回错误消息
     *
     * @return 错误消息
     */
    public static CommonResult error() {
        return CommonResult.error("操作失败");
    }

    /**
     * 返回错误消息
     *
     * @param msg 返回内容
     * @return 错误消息
     */
    public static CommonResult error(String msg) {
        return CommonResult.error(msg, null);
    }

    /**
     * 返回错误消息
     *
     * @param msg  返回内容
     * @param data 数据对象
     * @return 错误消息
     */
    public static CommonResult error(String msg, Object data) {
        return new CommonResult(HttpStatus.ERROR, msg, data);
    }

    /**
     * 返回错误消息
     *
     * @param code 状态码
     * @param msg  返回内容
     * @return 错误消息
     */
    public static CommonResult error(int code, String msg) {
        return new CommonResult(code, msg, null);
    }

    /**
     * 是否为成功消息
     *
     * @return 结果
     */
    public boolean isSuccess() {
        return Objects.equals(HttpStatus.SUCCESS, this.get(CODE_TAG));
    }

    /**
     * 是否为警告消息
     *
     * @return 结果
     */
    public boolean isWarn() {
        return Objects.equals(HttpStatus.WARN, this.get(CODE_TAG));
    }

    /**
     * 是否为错误消息
     *
     * @return 结果
     */
    public boolean isError() {
        return Objects.equals(HttpStatus.ERROR, this.get(CODE_TAG));
    }

    /**
     * 方便链式调用
     *
     * @param key   键
     * @param value 值
     * @return 数据对象
     */
    @Override
    public CommonResult put(String key, Object value) {
        super.put(key, value);
        return this;
    }
}
```

### 1.6 定义业务异常

包名`com.thuwsy.aoyou.common.exception`

```java
public class ServiceException extends RuntimeException {

    private static final long serialVersionUID = 1L;

    /**
     * 错误码
     */
    private Integer code;

    /**
     * 错误提示
     */
    private String message;
    /**
     * 错误明细，内部调试错误
     */
    private String detailMessage;

    /**
     * 空构造方法，避免反序列化问题
     */
    public ServiceException() {
    }

    public ServiceException(String message) {
        this.message = message;
    }

    public ServiceException(Integer code,String message) {
        this.message = message;
        this.code = code;
    }

    public String getDetailMessage() {
        return detailMessage;
    }

    public String getMessage() {
        return message;
    }

    public Integer getCode() {
        return code;
    }

    public ServiceException setMessage(String message) {
        this.message = message;
        return this;
    }
}
```

### 1.7 全局异常处理器

包名`com.thuwsy.aoyou.common.exception`

```java
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {
    /**
     * 处理项目的自定义异常
     */
    @ExceptionHandler(ServiceException.class)
    public CommonResult serviceExceptionHandler(ServiceException e) {
        log.error("【service异常】{}", e.getMessage());
        return CommonResult.error(e.getCode(), e.getMessage());
    }

    /**
     * 处理其他异常
     */
    @ExceptionHandler(Exception.class)
    public CommonResult exceptionHandler(Exception e) {
        log.error("【服务器异常】{}", e.getMessage());
        return CommonResult.error(HttpStatus.ERROR, "操作异常");
    }
}
```

## 2. support模块

### 2.1 MyBatis-Plus分页插件配置

包名`com.thuwsy.aoyou.support.config.mybatisplus`

```java
@Configuration
@MapperScan("com.thuwsy.aoyou.*.mapper")
public class MyBatisPlusConfig {
    /**
     * 添加分页插件
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
```

### 2.2 MyBatis-Plus自动填充功能

包名`com.thuwsy.aoyou.support.config.mybatisplus`

```java
@Component
public class MyMetaObjectHandler implements MetaObjectHandler {
    /**
     * 新增时调用
     */
    @Override
    public void insertFill(MetaObject metaObject) {
        LocalDateTime now = LocalDateTime.now();
        this.strictInsertFill(metaObject, "createTime", () -> now, LocalDateTime.class);
        this.strictInsertFill(metaObject, "updateTime", () -> now, LocalDateTime.class);
    }

    /**
     * 修改时调用
     */
    @Override
    public void updateFill(MetaObject metaObject) {
        LocalDateTime now = LocalDateTime.now();
        this.strictUpdateFill(metaObject, "updateTime", () -> now, LocalDateTime.class);
    }
}
```

除此之外，在common模块的实体类的需要自动填充的字段上标注：

```java
@TableField(fill = FieldFill.INSERT)
private LocalDateTime createTime;

@TableField(fill = FieldFill.INSERT_UPDATE)
private LocalDateTime updateTime;
```

## 3. starter模块

首先在common模块中引入依赖：

```xml
<dependency>
    <groupId>com.mysql</groupId>
    <artifactId>mysql-connector-j</artifactId>
</dependency>
```

然后在starter模块中创建配置文件：

```yaml
server:
  port: 8088
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://192.168.231.202:3306/aoyou_fast
    username: root
    password: abc666
```

## 4. 接口的基本测试

### 4.1 common模块

新增系统用户和查询所有系统用户的API：

```java
public interface IUmsSysUserService {
    /**
     * 新增系统用户
     */
    int save(UmsSysUser user);

    /**
     * 查询所有系统用户
     */
    List<UmsSysUser> list();
}
```

```java
@Service
public class UmsSysUserServiceImpl implements IUmsSysUserService {
    @Autowired
    private UmsSysUserMapper umsSysUserMapper;
    
    @Override
    public int save(UmsSysUser user) {
        return umsSysUserMapper.insert(user);
    }

    @Override
    public List<UmsSysUser> list() {
        return umsSysUserMapper.selectList(null);
    }
}
```

### 4.2 auth模块

包名`com.thuwsy.aoyou.auth.controller`

```java
@RestController
@RequestMapping("/ums/user")
public class UmsSysUserController {
    @Autowired
    private IUmsSysUserService sysUserService;

    /**
     * 新增用户接口
     */
    @PostMapping
    public CommonResult addSysUser(@RequestBody UmsSysUser user) {
        int result = sysUserService.save(user);
        return result > 0 ? CommonResult.success() : CommonResult.error();
    }

    /**
     * 查询用户列表接口
     */
    @GetMapping
    public CommonResult searchList() {
        List<UmsSysUser> list = sysUserService.list();
        return CommonResult.success(list);
    }
}
```

### 4.3 测试

（1）发送POST请求给`http://localhost:8088/ums/user`，响应体内容为

```json
{
    "username": "wangqiu",
    "nickname": "王秋儿",
    "email": "wangqiu@126.com",
    "mobile": "18966688888",
    "sex": 1,
    "avatar": "http://image.com",
    "password": "123456",
    "status": 0,
    "creator": "admin",
    "updater": "admin",
    "remark": "黄金龙女"
}
```

（2）发送GET请求给`http://localhost:8088/ums/user`

# 第03章_认证模块开发

## 1. 前端login页面

### 1.1 登录页路由配置

（1）清空`App.vue`中的内容，修改为

```vue
<template>
  <!-- 容器 -->
  <RouterView />
</template>

<script setup lang="ts">
import { RouterView } from 'vue-router'
</script>

<style scoped>

</style>
```

（2）清空components、stores、views这三个文件夹，然后在views下创建`Login.vue`

（3）删除assets目录下的`base.css`和`main.css`（同时删除`main.ts`中的`import './assets/main.css'`）

（4）修改router下的`index.ts`

```ts
import { createRouter, createWebHistory } from 'vue-router'
import Login from '../views/Login.vue'

// 配置路由规则
const constRouter = [
  // 重定向
  {
    path: '/',
    redirect: '/login'
  },
  {
    path: '/login',
    name: 'login',
    component: Login
  }
]

// 创建路由
const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: constRouter
})

export default router
```

### 1.2 安装element-plus

（1）给前端项目安装`npm install element-plus --save`

> element-plus官网 https://element-plus.org/zh-CN/

（2）根据官网的按需导入流程，需要安装以下两个插件：

```powershell
npm install -D unplugin-vue-components unplugin-auto-import
```

（3）将下列代码插入到`vite.config.ts`配置文件中

```ts
// vite.config.ts
import { defineConfig } from 'vite'
import AutoImport from 'unplugin-auto-import/vite'
import Components from 'unplugin-vue-components/vite'
import { ElementPlusResolver } from 'unplugin-vue-components/resolvers'

export default defineConfig({
  // ...
  plugins: [
    // ...
    AutoImport({
      resolvers: [ElementPlusResolver()],
    }),
    Components({
      resolvers: [ElementPlusResolver()],
    }),
  ],
})
```

（4）安装icon图标

```powershell
npm install @element-plus/icons-vue
```

并在`main.ts`中注册所有图标

```ts
// main.ts

import * as ElementPlusIconsVue from '@element-plus/icons-vue'

const app = createApp(App)

for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
  app.component(key, component)
}
```

（5）安装sass、axios

```powershell
npm install sass
npm install axios
```

（6）在`main.ts`中添加一些弹窗和加载的样式

```ts
import 'element-plus/theme-chalk/el-loading.css';
import 'element-plus/theme-chalk/el-message.css';
import 'element-plus/theme-chalk/el-message-box.css';
```

### 1.3 登录页

在`index.html`中添加

```html
<style>
  * {
    margin: 0;
    padding: 0;
  }
</style>
```

编写`Login.vue`

```vue
<template>
    <!-- 根div -->
    <div class="login_container">
        <!-- 登录表单 -->
        <div class="login_form">
            <h3 class="title">遨游快速开发平台</h3>
            <el-form ref="formRef" :model="loginForm"> 
                <!-- 用户名 -->
                <el-form-item>
                    <el-input v-model="loginForm.account" placeholder="请输入账号">
                        <template #prefix>
                            <el-icon class="el-input__icon"><User /></el-icon>
                        </template>
                    </el-input>
                </el-form-item>
                <!-- 密码 -->
                <el-form-item>
                    <el-input v-model="loginForm.password" type="password" placeholder="请输入密码">
                        <template #prefix>
                            <el-icon class="el-input__icon"><Lock /></el-icon>
                        </template>                        
                    </el-input>
                </el-form-item>

                <div class="rememberMe">
                    <!-- 记住我 -->
                    <el-checkbox v-model="loginForm.rememberMe" label="记住我" size="large" />
                    <!-- 忘记密码 -->
                    <el-text class="forgetpass mx-1" type="primary">忘记密码?</el-text>
                </div>
                <!-- 分割线 -->
                <el-divider>其他登录方式</el-divider>

                <!-- 其他登录方式 -->
                <div class="other_login">
                    <el-icon class="other_login_item"><ChromeFilled /></el-icon>
                    <el-icon class="other_login_item"><ElemeFilled /></el-icon>
                    <el-icon class="other_login_item"><WindPower /></el-icon>
                </div>

                <!-- 按钮 -->
                <el-form-item>
                    <el-button style="width: 100%;" type="primary" @click="handleLogin">登录</el-button>
                </el-form-item>
            </el-form>
        </div>
    </div>
</template>

<script setup lang="ts">
    import {ref} from 'vue'
    // 声明表单绑定值
    const loginForm = ref({
        account: undefined,
        password: undefined,
        rememberMe: undefined
    })

    // 声明方法
    function handleLogin() {
        
    }
</script>

<style lang="scss" scoped>
.login_container {
    // 背景图（放一张背景图到src/assets/bgimg/1.jpg）
    background-image: url('../assets/bgimg/1.jpg');
    background-size: 100%;
    height: 100vh;
    display: flex;
    justify-content: flex-end;

    .login_form {
        display: flex;
        justify-content: center;
        align-items: center;
        // 设置换行
        flex-direction: column;
        // 登录表单所占宽度
        width: 40%;
        background-color: #fff;

        .title {
            margin-bottom: 20px;
        }
        .rememberMe {
            display: flex;
            justify-content: space-between;
            align-items: center;
            .forgetpass {
                cursor: pointer;
            }
        }
        .other_login {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            .other_login_item {
                margin-left: 30px;
                margin-right: 30px;
                cursor: pointer;
            }
        }
    }
}

.el-form {
    width: 60%;
}
.el-form-item {
    width: 100%;
}
</style>
```

### 1.4 封装axios

在src目录下创建utils目录，其中新建`request.ts`

```ts
// 封装axios，做请求处理
// 导入axios
import axios from 'axios'
// 导入router
import router from '@/router'
import { ElMessage } from 'element-plus';

// Token将来会从pinia中获取，这里先临时定义一个
let token = '';
// 创建axios
const request = axios.create({
    // 根请求地址
    baseURL: 'http://127.0.0.1:8088/',
    withCredentials: false, // 用于配置请求接口跨域时是否需要凭证
    timeout: 30000 // 超时时间，单位ms
})

// 配置请求头的参数类型和编码格式
axios.defaults.headers['Content-Type'] = 'application/json?charset=utf-8'

// 配置请求的拦截器
request.interceptors.request.use((config) => {
    // 在请求头添加token, 判断是否需要发送token
    if (token) {
        config.headers['Authorization'] = token;
    }
    return config;
}, (error) => {
    // 发生异常
    console.log("请求异常====>",error);
    return Promise.reject(error);
})

// 配置响应拦截器
request.interceptors.response.use((response) => {
    // 判断响应码，后端返回的数据是code, data, msg
    let {msg, code} = response.data;
    console.log("code=====>", code, 'msg====>', msg);
    if (code == null) {
        return response;
    } else if (code == 200) {
        return response;
    } else if (code == 500) {
        ElMessage.error(msg);
    } else if (code == 403) {
        ElMessage.error('没有操作权限！');
    } else if (code == 401) {
        ElMessage.error('登录过期！');
        // 需要重新登陆，跳转到登录页面，清除pinia中的数据，在sessionStorage中
        window.sessionStorage.clear();
        router.push('/login');
    }
    return Promise.reject(msg);
}, (error) => {
    // 出现异常
    ElMessage.error('error=====>', error);
    window.sessionStorage.clear();
    router.push('/login');
    return Promise.reject(error);
})

// 导出
export default request;
```

### 1.5 登录接口

创建`src/api/auth/index.ts`

```ts
import request from "@/utils/request";

// 登录接口
export function login(data: any) {
    return request({
        url: 'auth/sys',
        method: 'POST',
        data: data
    }) 
}
```

在`Login.vue`中完善登录相关的ts代码：

```ts
<script setup lang="ts">
    import {ref} from 'vue'
    import {login} from '@/api/auth';

    // 声明表单绑定值
    const loginForm = ref({
        account: undefined,
        password: undefined,
        rememberMe: undefined
    })

    // 登录方法
    function handleLogin() {
        // 调用login方法
        login(loginForm.value).then((res) => {
            console.log('登录===>', res);
            // 判断是否成功
            if (res.data.code == 200) {
                // 将token存储到pinia中
                console.log('登陆成功!');
            }
        })
    }
</script>
```

## 2. 后端整合Spring Security

### 2.1 添加依赖

在common模块中添加依赖：

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
<dependency>
    <groupId>com.auth0</groupId>
    <artifactId>java-jwt</artifactId>
</dependency>
<dependency>
    <groupId>com.alibaba.fastjson2</groupId>
    <artifactId>fastjson2</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

### 2.2 Redis配置

（1）在starter模块的配置文件中配置Redis

```yaml
spring:   
  # redis配置
  data:
    redis:
      host: 192.168.231.202
      port: 6379
      password: abc666
      database: 0
      timeout: 10s # 连接超时时间
      lettuce:
        pool:
          min-idle: 0 # 连接池中的最小空闲连接
          max-idle: 8 # 连接池中的最大空闲连接
          max-active: 8 # 连接池的最大数据库连接数
          max-wait: -1ms #连接池最大阻塞等待时间（使用负值表示没有限制）
```

（2）在common模块添加Redis的配置类，包名`com.thuwsy.aoyou.common.config`

```java
public class FastJson2JsonRedisSerializer<T> implements RedisSerializer<T> {
    public static final Charset DEFAULT_CHARSET = Charset.forName("UTF-8");

    private Class<T> clazz;

    public FastJson2JsonRedisSerializer(Class<T> clazz) {
        super();
        this.clazz = clazz;
    }

    @Override
    public byte[] serialize(T t) throws SerializationException {
        if (t == null) {
            return new byte[0];
        }
        return JSON.toJSONString(t, JSONWriter.Feature.WriteClassName).getBytes(DEFAULT_CHARSET);
    }

    @Override
    public T deserialize(byte[] bytes) throws SerializationException {
        if (bytes == null || bytes.length <= 0) {
            return null;
        }
        String str = new String(bytes, DEFAULT_CHARSET);
        return JSON.parseObject(str, clazz, JSONReader.Feature.SupportAutoType);
    }
}
```

```java
@Configuration
@EnableCaching // 开启缓存
public class RedisConfig {
    @Bean
    @SuppressWarnings(value = {"unchecked", "rawtypes"})
    public RedisTemplate<Object, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<Object, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        FastJson2JsonRedisSerializer serializer = new FastJson2JsonRedisSerializer(Object.class);
        // 使用StringRedisSerializer来序列化和反序列化redis的key值
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(serializer);
        // Hash的key也采用StringRedisSerializer的序列化方式
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(serializer);
        template.afterPropertiesSet();
        return template;
    }
}
```

（3）在common模块添加操作Redis的工具类，包名`com.thuwsy.aoyou.common.utils`

```java
@Component
public class RedisCacheUtil {

    @Autowired
    public RedisTemplate redisTemplate;

    /**
     * 缓存基本的对象，Integer、String、实体类等
     *
     * @param key   缓存的键值
     * @param value 缓存的值
     */
    public <T> void setCacheObject(final String key, final T value) {
        redisTemplate.opsForValue().set(key, value);
    }

    /**
     * 缓存基本的对象，Integer、String、实体类等
     *
     * @param key      缓存的键值
     * @param value    缓存的值
     * @param timeout  时间
     * @param timeUnit 时间颗粒度
     */
    public <T> void setCacheObject(final String key, final T value, final Integer timeout, final TimeUnit timeUnit) {
        redisTemplate.opsForValue().set(key, value, timeout, timeUnit);
    }

    /**
     * 设置有效时间
     *
     * @param key     Redis键
     * @param timeout 超时时间
     * @return true=设置成功；false=设置失败
     */
    public boolean expire(final String key, final long timeout) {
        return expire(key, timeout, TimeUnit.SECONDS);
    }

    /**
     * 设置有效时间
     *
     * @param key     Redis键
     * @param timeout 超时时间
     * @param unit    时间单位
     * @return true=设置成功；false=设置失败
     */
    public boolean expire(final String key, final long timeout, final TimeUnit unit) {
        return redisTemplate.expire(key, timeout, unit);
    }

    /**
     * 获得缓存的基本对象。
     *
     * @param key 缓存键值
     * @return 缓存键值对应的数据
     */
    public <T> T getCacheObject(final String key) {
        ValueOperations<String, T> operation = redisTemplate.opsForValue();
        return operation.get(key);
    }

    /**
     * 删除单个对象
     *
     * @param key
     */
    public boolean deleteObject(final String key) {
        return redisTemplate.delete(key);
    }

    /**
     * 删除集合对象
     *
     * @param collection 多个对象
     * @return
     */
    public long deleteObject(final Collection collection) {
        return redisTemplate.delete(collection);
    }

    /**
     * 缓存List数据
     *
     * @param key      缓存的键值
     * @param dataList 待缓存的List数据
     * @return 缓存的对象
     */
    public <T> long setCacheList(final String key, final List<T> dataList) {
        Long count = redisTemplate.opsForList().rightPushAll(key, dataList);
        return count == null ? 0 : count;
    }

    /**
     * 获得缓存的list对象
     *
     * @param key 缓存的键值
     * @return 缓存键值对应的数据
     */
    public <T> List<T> getCacheList(final String key) {
        return redisTemplate.opsForList().range(key, 0, -1);
    }

    /**
     * 缓存Set
     *
     * @param key     缓存键值
     * @param dataSet 缓存的数据
     * @return 缓存数据的对象
     */
    public <T> BoundSetOperations<String, T> setCacheSet(final String key, final Set<T> dataSet) {
        BoundSetOperations<String, T> setOperation = redisTemplate.boundSetOps(key);
        Iterator<T> it = dataSet.iterator();
        while (it.hasNext()) {
            setOperation.add(it.next());
        }
        return setOperation;
    }

    /**
     * 获得缓存的set
     *
     * @param key
     * @return
     */
    public <T> Set<T> getCacheSet(final String key) {
        return redisTemplate.opsForSet().members(key);
    }

    /**
     * 缓存Map
     *
     * @param key
     * @param dataMap
     */
    public <T> void setCacheMap(final String key, final Map<String, T> dataMap) {
        if (dataMap != null) {
            redisTemplate.opsForHash().putAll(key, dataMap);
        }
    }

    /**
     * 获得缓存的Map
     *
     * @param key
     * @return
     */
    public <T> Map<String, T> getCacheMap(final String key) {
        return redisTemplate.opsForHash().entries(key);
    }

    /**
     * 往Hash中存入数据
     *
     * @param key   Redis键
     * @param hKey  Hash键
     * @param value 值
     */
    public <T> void setCacheMapValue(final String key, final String hKey, final T value) {
        redisTemplate.opsForHash().put(key, hKey, value);
    }

    /**
     * 获取Hash中的数据
     *
     * @param key  Redis键
     * @param hKey Hash键
     * @return Hash中的对象
     */
    public <T> T getCacheMapValue(final String key, final String hKey) {
        HashOperations<String, String, T> opsForHash = redisTemplate.opsForHash();
        return opsForHash.get(key, hKey);
    }

    /**
     * 删除Hash中的数据
     *
     * @param key
     * @param hKey
     */
    public void delCacheMapValue(final String key, final String hKey) {
        HashOperations hashOperations = redisTemplate.opsForHash();
        hashOperations.delete(key, hKey);
    }

    /**
     * 获取多个Hash中的数据
     *
     * @param key   Redis键
     * @param hKeys Hash键集合
     * @return Hash对象集合
     */
    public <T> List<T> getMultiCacheMapValue(final String key, final Collection<Object> hKeys) {
        return redisTemplate.opsForHash().multiGet(key, hKeys);
    }

    /**
     * 获得缓存的基本对象列表
     *
     * @param pattern 字符串前缀
     * @return 对象列表
     */
    public Collection<String> keys(final String pattern) {
        return redisTemplate.keys(pattern);
    }
}
```

### 2.3 实体类

- 封装请求，包名`com.thuwsy.aoyou.common.domain.dto`

```java
@Data
public class LoginDto implements Serializable {
    private String account;
    private String password;
    private Boolean rememberMe;
}
```

- 用户实体类，Spring Security会将认证的用户信息保存到UserDetails，所以我们的**用户实体类要实现UserDetails接口**，包名`com.thuwsy.aoyou.common.domain.vo`

```java
@Data
public class LoginUserVO implements UserDetails {
    private Long id;
    private String token;
    private long loginTime;
    // 用户信息
    private UmsSysUser sysUser = new UmsSysUser();

    @Override // 用户的权限
    public Collection<? extends GrantedAuthority> getAuthorities() {
        List<String> perms = sysUser.getPerms();
        if (ObjectUtil.isNotEmpty(perms)) {
            // 通过stream将List<String>转为Collection<GrantedAuthority>
            return perms.stream().map(SimpleGrantedAuthority::new)
                    .collect(Collectors.toList());
        }
        return new ArrayList<>();
    }

    @Override
    public String getPassword() {
        return sysUser.getPassword();
    }

    @Override
    public String getUsername() {
        return sysUser.getUsername();
    }

    @Override
    public boolean isAccountNonExpired() {
        return sysUser.getStatus() == 0;
    }

    @Override
    public boolean isAccountNonLocked() {
        return sysUser.getStatus() == 0;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return sysUser.getStatus() == 0;
    }

    @Override
    public boolean isEnabled() {
        return sysUser.getStatus() == 0;
    }
}
```

**注意**：我们需要在实体类`UmsSysUser`中添加两个字段，代表用户的角色信息和权限信息

```java
// 角色信息
@TableField(exist = false)
private List<UmsRole> roleList = new ArrayList<>();
// 权限信息
@TableField(exist = false)
private List<String> perms = new ArrayList<>();
```

### 2.4 JWT工具类

我们先定义一个常量，包名`com.thuwsy.aoyou.common.constants`

```java
public class CacheConstants {
    // 认证后的用户key前缀
    public static final String LOGIN_USER_KEY = "login_key:";
}
```

再创建JWT工具类，包名`com.thuwsy.aoyou.common.utils`

```java
@Component
public class JwtUtil {
    private final String secret = "fjsdlqwriijioqwjrjo"; // JWT签名秘钥
    @Autowired
    private RedisCacheUtil redisCacheUtil;

    /**
     * 创建JWT令牌，会将用户数据存放到Redis中，使用UUID作为Redis中的key
     * 可以方便实现单点登录、踢人下线、查看在线用户等功能
     */
    public String createJwt(LoginUserVO loginUserVO) {
        // 1. 在JWT令牌中只存储用户的uuid
        String token = UUID.randomUUID().toString().replaceAll("-", "");
        loginUserVO.setToken(token); // 保存uuid
        loginUserVO.setLoginTime(System.currentTimeMillis()); // 登录时间
        // 2. 调用刷新Token方法，将用户信息保存到Redis，并设置过期时间
        refreshToken(loginUserVO);
        // 3. 加密算法
        Algorithm algorithm = Algorithm.HMAC256(secret);
        // 4. 创建JWT令牌
        return JWT.create().withClaim("token", token).sign(algorithm);
    }

    // 刷新token
    private void refreshToken(LoginUserVO loginUserVO) {
        redisCacheUtil.setCacheObject(
                CacheConstants.LOGIN_USER_KEY + loginUserVO.getToken(),
                loginUserVO,24, TimeUnit.HOURS
        );
    }

    /**
     * 解析请求头中的JWT令牌
     */
    public DecodedJWT resolveJwt(String headerToken) {
        // 1. 将请求头中的内容，去掉"Bearer "前缀，转换为标准的JWT令牌
        String jwt = convertToken(headerToken);
        if (jwt == null) return null;

        // 2. 根据私钥和加密算法，得到JWT校验器
        Algorithm algorithm = Algorithm.HMAC256(secret);
        JWTVerifier jwtVerifier = JWT.require(algorithm).build();

        // 3. 验证token的签名正确
        try {
            // 如果token被人篡改，则会校验失败，抛出JWTVerificationException
            DecodedJWT decodedJWT = jwtVerifier.verify(jwt);
            return decodedJWT;
        } catch (JWTVerificationException e) {
            return null;
        }
    }

    // 将请求头中的内容，去掉"Bearer "前缀，转换为标准的JWT令牌
    private String convertToken(String headerToken) {
        if (headerToken == null || !headerToken.startsWith("Bearer "))
            return null;
        return headerToken.substring(7);
    }

    /**
     * 获取已登录的用户信息
     */
    public LoginUserVO getLoginUser(String headerToken) {
        // 1. 解析请求头中的JWT令牌
        DecodedJWT decodedJWT = resolveJwt(headerToken);
        if (decodedJWT == null) return null;

        // 2. 提取JWT中用户的uuid
        String token = decodedJWT.getClaims().get("token").asString();

        // 3. 从Redis中获取用户信息
        LoginUserVO loginUserVO = redisCacheUtil.getCacheObject(
                CacheConstants.LOGIN_USER_KEY + token);
        if (loginUserVO == null) return null;

        // 4. 刷新令牌的过期时间
        // 为了防止用户正在操作时令牌突然过期
        // 于是在令牌过期时间剩余1小时内，如果用户有操作，则自动续期
        long loginTime = loginUserVO.getLoginTime();
        long currentTime = System.currentTimeMillis();
        long hours = (currentTime - loginTime) / 1000 / 3600;
        if (hours >= 23) {
            loginUserVO.setLoginTime(currentTime);
            refreshToken(loginUserVO);
        }
        return loginUserVO;
    }

    /**
     * 用户退出登录后，从Redis中删除key
     */
    public boolean deleteLoginUser(String headerToken) {
        // 1. 解析请求头中的JWT令牌
        DecodedJWT decodedJWT = resolveJwt(headerToken);
        if (decodedJWT == null) return false;

        // 2. 提取JWT中用户的uuid
        String token = decodedJWT.getClaims().get("token").asString();

        // 3. 删除Redis中的用户信息
        return redisCacheUtil.deleteObject(
                CacheConstants.LOGIN_USER_KEY + token);
    }
}
```

### 2.5 JWT校验过滤器

我们需要一个用于对请求头中JWT令牌进行校验的过滤器，如果JWT令牌合法，即该用户是已登录状态，就将用户信息保存到SecurityContext中。包名：`com.thuwsy.aoyou.support.filter`

```java
// 继承OncePerRequestFilter表示每次请求过滤一次
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    @Autowired
    private JwtUtil jwtUtil;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain)
            throws ServletException, IOException {

        // 1. 首先从请求头中取出JWT并解析，获取用户信息
        String headerToken = request.getHeader("Authorization");
        LoginUserVO user = jwtUtil.getLoginUser(headerToken);

        // 2. 如果jwt合法，则将用户信息保存到SecurityContext，表示已完成验证
        if (user != null) {
            UsernamePasswordAuthenticationToken authentication =
                    new UsernamePasswordAuthenticationToken(user, null, user.getAuthorities());
            authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
            SecurityContextHolder.getContext().setAuthentication(authentication);
        }

        // 3. 最后放行，执行下一个过滤器
        filterChain.doFilter(request, response);
    }
}
```

> 注意：我们还需要将该过滤器在配置类中加入Security的过滤器链。详见Security配置类。

### 2.6 用户认证和授权

#### 1、用户和权限查询的mapper

- 在UmsSysUserMapper中增加API，包名`com.thuwsy.aoyou.common.mapper`

```java
@Mapper
public interface UmsSysUserMapper extends BaseMapper<UmsSysUser> {
    // 根据用户名或手机或邮箱，查询用户及其角色信息
    UmsSysUser selectUserByUserName(
            @Param("account") String account,
            @Param("accountType") int accountType
    );
}
```

- 利用MyBatisX插件，在对应的`resources/mapper/`目录下生成对应的mapper映射文件

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.thuwsy.aoyou.common.mapper.UmsSysUserMapper">

    <!-- 配置sysUser映射 -->
    <resultMap id="SysUserResultMap" type="com.thuwsy.aoyou.common.domain.entity.UmsSysUser">
        <id column="id" property="id"/>
        <result column="username" property="username"/>
        <result column="nickname" property="nickname"/>
        <result column="email" property="email"/>
        <result column="mobile" property="mobile"/>
        <result column="sex" property="sex"/>
        <result column="avatar" property="avatar"/>
        <result column="password" property="password"/>
        <result column="status" property="status"/>
        <result column="creator" property="creator"/>
        <result column="updater" property="updater"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="remark" property="remark"/>
        <result column="deleted" property="deleted"/>
        <collection property="roleList" javaType="list" resultMap="UmsRoleResult"/>
    </resultMap>

    <!-- 配置角色映射 -->
    <resultMap id="UmsRoleResult" type="com.thuwsy.aoyou.common.domain.entity.UmsRole">
        <id column="role_id" property="roleId"/>
        <result column="role_label" property="roleLabel"/>
        <result column="role_name" property="roleName"/>
        <result column="sort" property="sort"/>
        <result column="status" property="status"/>
        <result column="creator" property="creator"/>
        <result column="updater" property="updater"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="remark" property="remark"/>
        <result column="deleted" property="deleted"/>
    </resultMap>

    <select id="selectUserByUserName" resultMap="SysUserResultMap">
        select
        sy.id,sy.username,sy.nickname,sy.email,sy.mobile,sy.sex,sy.avatar,sy.password,
        sy.status,sy.creator, sy.updater,sy.create_time,sy.update_time,sy.remark,
        ur.role_id,ur.role_label,ur.role_name,ur.sort
        from ums_sys_user sy
        left join ums_sys_user_role sur on sy.id = sur.user_id
            left join ums_role ur on ur.role_id = sur.role_id
        <where>
            sy.deleted = 0 and ur.deleted = 0 and
            <if test="accountType == 0">
                sy.username = #{account}
            </if>
            <if test="accountType == 1">
                sy.mobile = #{account}
            </if>
            <if test="accountType == 2">
                sy.email = #{account}
            </if>
        </where>
    </select>
</mapper>
```

- 在UmsMenuMapper中增加API，包名`com.thuwsy.aoyou.common.mapper`

```java
@Mapper
public interface UmsMenuMapper extends BaseMapper<UmsMenu> {
    // 根据角色id，查询其拥有的菜单权限
    List<UmsMenu> selectByRoleIds(@Param("roleIds") List<Long> roleIds);
}
```

- 利用MyBatisX插件，在对应的`resources/mapper/`目录下生成对应的mapper映射文件

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.thuwsy.aoyou.common.mapper.UmsMenuMapper">
    <select id="selectByRoleIds" resultType="com.thuwsy.aoyou.common.domain.entity.UmsMenu">
        select distinct um.id,um.parent_id,um.menu_name,um.sort,
               um.menu_type,um.path,um.component_path,um.perms,um.icon
        from ums_menu um left join ums_role_menu urm on um.id = urm.menu_id
        where urm.role_id in
        <foreach collection="roleIds" open="(" close=")" separator="," item="roleId">
            #{roleId}
        </foreach>
        and um.deleted = 0 and um.status = 0
    </select>
</mapper>
```

#### 2、创建UserDetailsService

我们需要创建一个类，实现UserDetailsService接口，其作用是根据username去数据库查询用户信息，然后封装成UserDetails返回。包名`com.thuwsy.aoyou.support.config.security`

```java
@Service
@Slf4j
public class SysUserDetailsService implements UserDetailsService {
    @Autowired
    private UmsSysUserMapper sysUserMapper;
    @Autowired
    private UmsMenuMapper umsMenuMapper;

    /**
     * 根据account查询用户
     * @param account 用户名/手机号/邮箱
     */
    @Override
    public UserDetails loadUserByUsername(String account) throws UsernameNotFoundException {
        // TODO 验证账号类型，这里为了我们简便，直接使用用户名类型
        int accountType = 0;

        // 1. 根据账号查询用户（同时查询出角色信息）
        UmsSysUser sysUser = sysUserMapper.selectUserByUserName(account, accountType);
        log.info("sysUser======>{}", sysUser);
        if (sysUser == null)
            throw new UsernameNotFoundException("用户名或密码错误");

        // 2. 取出用户的角色id
        List<Long> roleIds = sysUser.getRoleList().stream()
                .map(UmsRole::getRoleId)
                .collect(Collectors.toList());

        // 3. 根据角色id，查询用户能操作的菜单
        List<UmsMenu> menuList = umsMenuMapper.selectByRoleIds(roleIds);

        // 4. 获取菜单中的权限字段
        List<String> perms = menuList.stream()
                .map(UmsMenu::getPerms)
                .collect(Collectors.toList());
        log.info("权限=======>{}", perms);

        // 5. 设置用户的权限
        sysUser.setPerms(perms);
        
        // 6. 封装成UserDetails并返回
        LoginUserVO loginUserVO = new LoginUserVO();
        loginUserVO.setSysUser(sysUser);
        loginUserVO.setId(sysUser.getId());
        return loginUserVO;
    }
}
```

#### 3、创建处理登录请求的controller

包名`com.thuwsy.aoyou.auth.controller`

```java
@RestController
@RequestMapping("/auth")
@Slf4j
public class AuthController {
    @Autowired
    private IAuthService authService;

    /**
     * 系统用户登录
     */
    @PostMapping("/sys")
    public CommonResult sysLogin(@RequestBody LoginDto loginDto) {
        String jwt = authService.login(loginDto);
        return CommonResult.success().put("token", jwt);
    }
}
```

#### 4、创建处理登录请求的service

包名`com.thuwsy.aoyou.common.service`

```java
public interface IAuthService {
    String login(LoginDto loginDto);
}
```

包名`com.thuwsy.aoyou.common.service.impl`

```java
@Service
public class AuthServiceImpl implements IAuthService {
    // SpringSecurity中使用AuthenticationManager验证账号密码
    @Autowired
    private AuthenticationManager authenticationManager;
    @Autowired
    private JwtUtil jwtUtil;

    @Override
    public String login(LoginDto loginDto) {
        // 1. 传入要验证的账号和密码
        UsernamePasswordAuthenticationToken authenticationToken =
                new UsernamePasswordAuthenticationToken(
                        loginDto.getAccount(),
                        loginDto.getPassword()
                );

        // 2. 调用AuthenticationManager的authenticate()方法验证用户名和密码
        // 其底层会调用UserDetailsService的loadUserByUsername()方法获取用户
        LoginUserVO user = null;
        try {
            Authentication authentication =
                    authenticationManager.authenticate(authenticationToken);
            // 3. 获取用户信息
            user = (LoginUserVO) authentication.getPrincipal();
            if (ObjectUtil.isNull(user))
                throw new Exception();
        } catch (Exception e) {
            throw new ServiceException(HttpStatus.ERROR, "用户名或密码错误");
        }

        // 4. 创建jwt
        return jwtUtil.createJwt(user);
    }
}
```

### 2.7 Security配置类

包名`com.thuwsy.aoyou.support.config.security`

```java
@EnableWebSecurity
@EnableMethodSecurity
@Configuration
public class SecurityConfig {
    @Autowired
    private SysUserDetailsService sysUserDetailsService;
    @Autowired
    private JwtAuthenticationFilter jwtAuthenticationFilter;
    @Autowired
    private JwtUtil jwtUtil;

    @Bean // 密码加密器（对密码进行加密，提高安全性）
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    /**
     * 注册AuthenticationManager，将它与UserDetailsService、PasswordEncoder关联
     */
    @Bean
    public AuthenticationManager authenticationManager(PasswordEncoder passwordEncoder) {
        // 它是AuthenticationProvider的一个常用实现类
        DaoAuthenticationProvider provider = new DaoAuthenticationProvider();
        // 关联使用的UserDetailsService
        provider.setUserDetailsService(sysUserDetailsService);
        // 关联使用的密码加密器
        provider.setPasswordEncoder(passwordEncoder);
        // 将AuthenticationProvider放入AuthenticationManager中
        return new ProviderManager(provider);
    }

    // 配置跨域
    public CorsConfigurationSource configurationSource() {
        CorsConfiguration corsConfiguration = new CorsConfiguration();
        corsConfiguration.setAllowedMethods(Collections.singletonList("*"));
        corsConfiguration.setAllowedHeaders(Collections.singletonList("*"));
        corsConfiguration.setAllowedOrigins(Collections.singletonList("*"));

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**",corsConfiguration);
        return source;
    }

    /**
     * 配置Security过滤器链
     */
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        // 1. 关闭CSRF防护
        http.csrf(conf -> conf.disable());

        // 2. 配置跨域
        http.cors(cors -> cors.configurationSource(configurationSource()));

        // 3. 设置需要认证的url
        http.authorizeHttpRequests(conf -> conf
                .requestMatchers("/auth/sys").permitAll() // 登录相关的url无需认证
                .anyRequest().authenticated() // 其余请求都需要认证(登录)
        );

        // 4. 退出登录相关配置
        http.logout(conf -> conf
                .logoutUrl("/auth/logout") // 退出登录提交post请求的url
                .logoutSuccessHandler(this::onLogoutSuccess) // 退出登录成功后的处理方法
        );

        // 5. 认证或授权失败时的处理方式
        http.exceptionHandling(conf -> conf
                // 用户未登录时的处理方法
                .authenticationEntryPoint(this::onUnauthorized)
                // 用户权限不足访问时的处理方法
                .accessDeniedHandler(this::onAccessDeny)
        );

        // 6. 使用基于token的校验，就需要将session改为无状态
        http.sessionManagement(conf -> conf
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
        );

        // 7. 将我们自定义的JwtAuthenticationFilter加入过滤器链
        // 注意，检验JWT的过滤器一定要在登录认证的过滤器之前
        http.addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    // 退出登录成功后的处理方法
    private void onLogoutSuccess(HttpServletRequest request,
                                 HttpServletResponse response,
                                 Authentication authentication)
            throws IOException, ServletException {

        response.setContentType("application/json;charset=utf-8");
        PrintWriter writer = response.getWriter();
        // 1. 获取请求头中的token内容
        String headerToken = request.getHeader("Authorization");

        // 2. 删除Redis中的用户信息
        if (jwtUtil.deleteLoginUser(headerToken)) {
            writer.write(JSON.toJSONString(CommonResult.success()));
        } else {
            CommonResult result = CommonResult.error(HttpStatus.UNAUTHORIZED, "用户未登录");
            response.getWriter().write(JSON.toJSONString(result));
        }
    }

    // 用户未登录时的处理方法
    private void onUnauthorized(HttpServletRequest request,
                                HttpServletResponse response,
                                AuthenticationException exception)
            throws IOException, ServletException {

        response.setContentType("application/json;charset=utf-8");
        CommonResult result = CommonResult.error(HttpStatus.UNAUTHORIZED, "用户未登录");
        response.getWriter().write(JSON.toJSONString(result));
    }

    // 用户权限不足访问时的处理方法
    private void onAccessDeny(HttpServletRequest request,
                              HttpServletResponse response,
                              AccessDeniedException exception)
            throws IOException, ServletException {

        response.setContentType("application/json;charset=utf-8");
        CommonResult result = CommonResult.error(HttpStatus.FORBIDDEN, "权限不足");
        response.getWriter().write(JSON.toJSONString(result));
    }
}
```

### 2.8 Security工具类

封装Security工具类，用于获取登录后的用户的相关信息。包名`com.thuwsy.aoyou.common.utils`

```java
public class SecurityUtil {
    /**
     * 获取Authentication
     */
    public static Authentication getAuthentication() {
        return SecurityContextHolder.getContext().getAuthentication();
    }

    /**
     * 获取用户
     */
    public static LoginUserVO getLoginUser() {
        return (LoginUserVO) getAuthentication().getPrincipal();
    }

    /**
     * 获取用户id
     */
    public static Long getUserId() {
        Long userId = getLoginUser().getId();
        if (ObjectUtil.isNull(userId)) {
            throw new ServiceException(HttpStatus.UNAUTHORIZED, "用户未登录");
        }
        return userId;
    }

    /**
     * 获取用户名
     */
    public static String getUsername() {
        String username = getLoginUser().getUsername();
        if (ObjectUtil.isNull(username)) {
            throw new ServiceException(HttpStatus.UNAUTHORIZED, "用户未登录");
        }
        return username;
    }
}
```



## 3. 前端存储jwt和查询菜单API

### 3.1 存储jwt

（1）创建操作token的工具，在`src/utils/token/index.ts`

```ts
// 存储token
export function setToken(tokenKey: string, token: string) {
    return localStorage.setItem(tokenKey, token);
}

// 获取token
export function getToken(tokenKey: string) {
    return localStorage.getItem(tokenKey);
}
// 移除token
export function removeToken(tokenKey: string) {
    if (getToken(tokenKey)) {
        return localStorage.removeItem(tokenKey);
    }
    return null;
}
```

（2）修改`Login.vue`中的脚本代码

```ts
<script setup lang="ts">
    import {ref} from 'vue'
    import {login} from '@/api/auth';
    import {setToken} from '@/utils/token';
    import {searchSelfRouter} from '@/api/user';

    // 声明表单绑定值
    const loginForm = ref({
        account: undefined,
        password: undefined,
        rememberMe: undefined
    })

    // 登录方法
    function handleLogin() {
        // 调用login方法
        login(loginForm.value).then((res) => {
            console.log('登录===>', res);
            // 判断是否成功
            if (res.data.code == 200) {
                // 将token存储到localStorage中
                setToken("aoyouToken", res.data.token);
                // TODO 查询用户的权限和菜单【设置页面路由实现动态路由】
                searchSelfRouter().then(res => {
                    console.log("res====>", res);
                })
            }
        })
    }
</script>
```

（3）修改`request.ts`

```ts
// 封装axios，做请求处理
// 导入axios
import axios from 'axios'
// 导入router
import router from '@/router'

import { ElMessage } from 'element-plus';
import { getToken, removeToken } from './token';

// 创建axios
const request = axios.create({
    // 根请求地址
    baseURL: 'http://127.0.0.1:8088/',
    withCredentials: false, // 用于配置请求接口跨域时是否需要凭证
    timeout: 30000 // 超时时间，单位ms
})

// 配置请求头的参数类型和编码格式
axios.defaults.headers['Content-Type'] = 'application/json?charset=utf-8'

// 配置请求的拦截器
request.interceptors.request.use((config) => {
    // 在请求头添加token, 判断是否需要发送token
    if (getToken('aoyouToken')) {
        // 添加Bearer 前缀
        config.headers['Authorization'] = 'Bearer ' + getToken('aoyouToken');
    }
    return config;
}, (error) => {
    // 发生异常
    console.log("请求异常====>",error);
    return Promise.reject(error);
})

// 配置响应拦截器
request.interceptors.response.use((response) => {
    // 判断响应码，后端返回的数据是code, data, msg
    let {msg, code} = response.data;
    console.log("code=====>", code, 'msg====>', msg);
    if (code == null) {
        return response;
    } else if (code == 200) {
        return response;
    } else if (code == 500) {
        ElMessage.error(msg);
    } else if (code == 403) {
        ElMessage.error('没有操作权限！');
    } else if (code == 401) {
        ElMessage.error('登录过期！');
        // 需要重新登陆，清除用户的相关数据，然后跳转到登录页面
        window.sessionStorage.clear();
        window.localStorage.clear();
        router.push('/login');
    }
    return Promise.reject(msg);
}, (error) => {
    // 出现异常
    ElMessage.error('error=====>', error);
    window.sessionStorage.clear();
    window.localStorage.clear();
    router.push('/login');
    return Promise.reject(error);
})

// 导出
export default request;
```

### 3.2 查询菜单API

- 在`src/api/user/index.ts`中

```ts
import request from '@/utils/request';

// 查询个人的菜单列表
export function searchSelfRouter() {
    return request({
        url: 'sys/menu/self',
        method: "GET"
    })
}

// 查询个人信息
export function searchSelfInfo() {
    return request({
        url: 'sys/user/info',
        method: "GET"
    })
}
```

## 4. 后端查询用户菜单

- 给实体类UmsMenu添加字段`children`(子菜单)。包名`com.thuwsy.aoyou.common.domain.entity`

```java
@TableField(exist = false)
private List<UmsMenu> children = new ArrayList<>();
```

- 创建实体类RouterVO。包名`com.thuwsy.aoyou.common.domain.vo`

```java
@Data
public class RouterVO implements Serializable {
    private Long id;
    private Long parentId;
    private String menuName;
    private String path;
    private String componentPath;
    private String icon;
    private Integer menuType;
    private List<RouterVO> children = new ArrayList<>();
}
```

- 在`UmsRoleMapper`中新增方法

```java
List<Long> selectByUserId(@Param("userId") Long userId);
```

- 创建对应的mapper映射文件

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.thuwsy.aoyou.common.mapper.UmsRoleMapper">
    <select id="selectByUserId" resultType="java.lang.Long">
        select role_id from ums_sys_user_role where user_id = #{userId}
    </select>
</mapper>
```

- 在`IUmsMenuService`中新增方法

```java
/**
 * 查询已登录用户自己的菜单
 */
List<RouterVO> searchSelfMenu();
```

- 在`UmsMenuServiceImpl`中实现该方法

```java
@Service
public class UmsMenuServiceImpl implements IUmsMenuService {
    @Autowired
    private UmsRoleMapper roleMapper;
    @Autowired
    private UmsMenuMapper menuMapper;

    /**
     * 获取个人菜单列表
     */
    @Override
    public List<RouterVO> searchSelfMenu() {
        // 1. 通过Security上下文获取登录的用户id
        Long userId = SecurityUtil.getUserId();
        // 2. 查询用户的角色信息
        List<Long> roleIds = roleMapper.selectByUserId(userId);
        // 3. 查询用户的菜单
        List<UmsMenu> menuList = menuMapper.selectByRoleIds(roleIds);
        // 4. 递归设置菜单的树形结构
        return getRouter(menuList);
    }

    /**
     * 获取路由
     */
    private List<RouterVO> getRouter(List<UmsMenu> menuList) {
        List<RouterVO> list = new ArrayList<>();
        // 1. 首先获取所有1级路由【parentId为0】
        List<UmsMenu> parentMenu = menuList.stream()
                .filter(item -> item.getParentId().equals(0L))
                .sorted((item1, item2) -> {
                    return item1.getSort() - item2.getSort();
                })
                .collect(Collectors.toList());
        // 2. 转换类型
        for (UmsMenu menu : parentMenu) {
            RouterVO routerVO = new RouterVO();
            BeanUtil.copyProperties(menu, routerVO);
            list.add(routerVO);
        }
        // 3. 遍历1级路由，获取其所有子节点【子节点的parentId为当前1级路由的id】
        for (RouterVO router : list) {
            List<RouterVO> children = buildTree(menuList, router.getId());
            router.setChildren(children);
        }
        return list;
    }

    /**
     * 递归获取当前菜单的所有子菜单
     */
    private List<RouterVO> buildTree(List<UmsMenu> menuList, Long parentId) {
        List<RouterVO> children = new ArrayList<>();
        // 遍历所有数据，如果当前菜单的parentId与传入参数相同，则是子菜单
        List<UmsMenu> menus = menuList.stream()
                .filter(item -> item.getParentId().equals(parentId))
                .sorted((item1, item2) -> {
                    return item1.getSort() - item2.getSort();
                })
                .collect(Collectors.toList());
        for (UmsMenu menu : menus) {
            RouterVO routerVO = new RouterVO();
            BeanUtil.copyProperties(menu, routerVO);
            children.add(routerVO);
        }

        // children中的菜单，还需要递归设置其子菜单
        for (RouterVO item : children) {
            item.setChildren(buildTree(menuList, item.getId()));
        }
        return children;
    }
}
```

- 完善controller接口。包名`com.thuwsy.aoyou.user.controller`

```java
@RestController
@RequestMapping("/sys/menu")
public class MenuController {
    @Autowired
    private IUmsMenuService menuService;

    /**
     * 查询自己的菜单列表
     */
    @GetMapping("/self")
    public CommonResult searchSelfMenu() {
        List<RouterVO> list = menuService.searchSelfMenu();
        return CommonResult.success(list);
    }
}
```

## 5. 前端使用pinia存储数据

- `src/stores/menu.ts`

```ts
import {defineStore} from 'pinia';

export const useMenuStore = defineStore('menu', {
    // 定义数据
    state: () => ({
        menuList: []
    }),
    // 获取数据的方法
    getters: {
        Array: (state) => state.menuList
    }, 
    // 操作数据的方法
    actions: {
        setMenuList(data) {
            console.log("setMenuList=======>", data);
            this.menuList = data;
        }
    }
})
```

- 修改`Login.vue`中的登录方法

```ts
    import {useMenuStore} from '@/stores/menu';
    // 构建store
    const menuStore = useMenuStore();

    // 登录方法
    function handleLogin() {
        // 调用login方法
        login(loginForm.value).then((res) => {
            console.log('登录===>', res);
            if (res.data.code == 200) {
                // 将token存储到localStorage中
                setToken("aoyouToken", res.data.token);
                // 查询用户的权限和菜单
                searchSelfRouter().then(res => {
                    if (res.data.code == 200) {
                        // 将路由信息存储到pinia中
                        menuStore.setMenuList(res.data.data);
                    }
                    // TODO 设置页面路由
                })
            }
        })
    }
```

# 第04章_项目主页开发

## 1. 实现登录后跳转项目主页

- 项目主页`src/Layout/index.vue`

```vue
<template>
    <div class="common-layout">
        <el-container>
            <el-aside width="200px">Aside</el-aside>
            <el-container>
                <el-header>Header</el-header>
                <el-main>Main</el-main>
            </el-container>
        </el-container>
    </div>
</template>
  

<script setup lang="ts" name="Layout">

</script>

<style lang="scss" scoped>

</style>
```

- 配置路由`src/router/index.ts`

```ts
...
import Layout from '@/Layout/index.vue'

const constRouter = [
  ...
  {
    path: '/home',
    name: 'home',
    component: Layout
  }
]

...
```

- 在`Login.vue`中添加首页跳转逻辑

```ts
    import {useRouter} from 'vue-router';
    const router = useRouter();

	// 登录方法
    function handleLogin() {
        // 调用login方法
        login(loginForm.value).then((res) => {
            console.log('登录===>', res);
            if (res.data.code == 200) {
                // 将token存储到localStorage中
                setToken("aoyouToken", res.data.token);
                // 查询用户的权限和菜单
                searchSelfRouter().then(res => {
                    if (res.data.code == 200) {
                        // 将路由信息存储到pinia中
                        menuStore.setMenuList(res.data.data);
                    }
                    // 跳转页面
                    router.push("/home")
                })
            }
        })
    }
```

## 2. 左侧导航栏

### 2.1 自定义icon

- 导入依赖

```powershell
npm install fast-glob
npm install vite-plugin-svg-icons
```

- `vite.config.ts`中添加

```ts
import { createSvgIconsPlugin } from 'vite-plugin-svg-icons'
import path from 'path'

export default defineConfig({
  plugins: [
    ...
    // 配置自定义icon
    createSvgIconsPlugin({
      iconDirs: [path.resolve(process.cwd(), 'src/assets/icons/svg')],
      symbolId: '[name]'
    }),
  ],
  ...
})
```

- 编写组件`src/components/SvgIcon/index.vue`

```vue
<template>
    <!-- svg:图标外层容器节点,内部需要与use标签结合使用 -->
    <svg :style="{ width, height }">
        <!-- xlink:href执行用哪一个图标,属性值务必#icon-图标名字 -->
        <!-- use标签fill属性可以设置图标的颜色 -->
        <use :xlink:href="prefix + name" :fill="color"></use>
    </svg>
</template>

<script setup lang="ts" name="SvgIcon">
    //接受父组件传递过来的参数
    defineProps({
        //xlink:href属性值前缀
        prefix: {
            type: String,
            default: "#",
        },
        //提供使用的图标名字
        name: String,
        //接受父组件传递颜色
        color: {
            type: String,
            default: "",
        },
        //接受父组件传递过来的图标的宽度
        width: {
            type: String,
            default: "16px",
        },
        //接受父组件传递过来的图标的高度
        height: {
            type: String,
            default: "16px",
        },
    })
</script>

<style lang="scss" scoped>

</style>
```

- 在`main.ts`中注册

```ts
import SvgIcon from '@/components/SvgIcon/index.vue';
import 'virtual:svg-icons-register';

app.component('svg-icon', SvgIcon);
```

- 前往阿里矢量库下载一些需要的icon资源 https://www.iconfont.cn/collections/detail?spm=a313x.collections_index.i1.d9df05512.4a5d3a81yEeSYm&cid=11607

> 我们下载了一些icon资源`.svg`文件，然后放在`src/assets/icons/svg/`目录下

- 当我们要使用icon时，添加如下代码即可

```vue
<svg-icon
    v-if="form.icon"
    slot="prefix"
    :name="form.icon"
    width="18px"
    height="18px"
/>
```

- 然后我们在数据库的`ums_menu`表中填充`icon`字段的值，这样就可以显示图标了，执行以下sql语句即可
  ```sql
  UPDATE ums_menu SET icon='home' WHERE menu_name='首页';
  UPDATE ums_menu SET icon='system' WHERE menu_name='系统管理';
  UPDATE ums_menu SET icon='tools' WHERE menu_name='系统工具';
  UPDATE ums_menu SET icon='pay' WHERE menu_name='支付管理';
  UPDATE ums_menu SET icon='account' WHERE menu_name='用户管理';
  UPDATE ums_menu SET icon='role' WHERE menu_name='角色管理';
  UPDATE ums_menu SET icon='menu' WHERE menu_name='菜单管理';
  UPDATE ums_menu SET icon='codeGen' WHERE menu_name='代码生成';
  ```

### 2.2 左侧导航栏组件

`src/Layout/Aside/index.vue`

```vue
<template>
    <div>
        <el-menu
            background-color="#304157"
            text-color="#b1becd"
            active-text-color="#336cab"
        >
            <!-- 遍历子元素 -->
            <template v-for="menu in menuList" :key="menu.path">
                <!-- 判断是否有子菜单 -->
                <el-sub-menu v-if="hasChildren(menu)" :index="menu.path">
                    <template #title>
                        <!-- 添加icon -->
                        <svg-icon
                            v-if="menu.icon"
                            slot="prefix"
                            :name="menu.icon" 
                            width="18px" 
                            height="18px"
                        />
                        <span class="spanStyle">{{ menu.menuName }}</span>
                    </template>
                    <!-- 渲染子菜单 -->
                    <el-menu-item-group>
                        <el-menu-item 
                            v-for="children in menu.children"
                            :index="children.path"
                            @click="handleRouter(children)"
                            >
                            <svg-icon
                                v-if="children.icon"
                                slot="prefix"
                                :name="children.icon" 
                                width="18px" 
                                height="18px"
                            />
                            <span class="spanStyle">{{ children.menuName }}</span>
                        </el-menu-item>
                    </el-menu-item-group>
                </el-sub-menu>

                <!-- 没有子菜单 -->
                <el-menu-item v-else :index="menu.path" @click="handleRouter(menu)">
                    <svg-icon
                        v-if="menu.icon"
                        slot="prefix"
                        :name="menu.icon" 
                        width="18px" 
                        height="18px"
                    />
                    <span class="spanStyle">{{ menu.menuName }}</span>
                </el-menu-item>
            </template>
        </el-menu>
    </div>
</template>

<script setup lang="ts" name="Aside">
    import { useMenuStore } from '@/stores/menu';
    import { storeToRefs } from 'pinia';
    import { useRouter } from 'vue-router';
    const router = useRouter()
    const menuStore = useMenuStore();
    const { menuList } = storeToRefs(menuStore);
    // 判断是否有子菜单
    function hasChildren(menu) {
        if (menu.children && menu.children.length > 0) {
            return true;
        }
        return false;
    }

    // 切换路由
    function handleRouter(menu) {
        router.push('/home/' + menu.path);
    }
</script>

<style lang="scss" scoped>
.spanStyle {
    margin-left: 10px;
}
</style>
```

### 2.3 项目主页添加左侧导航栏

修改项目主页`src/Layout/index.vue`，添加左侧导航栏

```vue
<template>
    <div class="common-layout">
        <el-container>
            <el-aside class="aside" :style="{ height : height + 'px', minHeight: minHeight + 'px'}">
                <Aside />
            </el-aside>
            <el-container>
                <el-header>Header</el-header>
                <el-main>Main</el-main>
            </el-container>
        </el-container>
    </div>
</template>

<script setup lang="ts" name="Layout">
    import { ref, onMounted } from 'vue';
    import Aside from './Aside/index.vue';

    const height = ref(0)
    const minHeight = ref(0)

    onMounted(() => {
        getHeight();
        // 监听页面缩放事件
        minHeight.value = document.documentElement.clientHeight;
        window.addEventListener('resize', getHeight)
    })

    // 获取文档高度
    function getHeight() {
        height.value = document.documentElement.clientHeight;
    }
</script>

<style lang="scss" scoped>
.aside {
    background-color: #2f4156;
}
</style>
```

## 3. 头部

### 3.1 项目主页添加头部

修改项目主页`src/Layout/index.vue`，添加头部：

- 在script标签中引入`import Header from './Header/index.vue';`
- 将template标签中的`<el-header>Header</el-header>`替换为`<el-header><Header /></el-header>`

### 3.2 头部组件

`src/Layout/Header/index.vue`

```vue
<template>
    <div class="header_container">
        <div class="header_left">
            遨游快速开发平台
        </div>
        <!-- 右侧是昵称、头像 -->
        <div class="header_right">
            <!-- 头像 -->
            <div class="avatar">
                <el-image :src="avatar" class="avatar_img"/>
            </div>
            <!-- 昵称 -->
            <div>
                <el-dropdown>
                    <span class="el-dropdown-link">
                    {{ nickname }}
                    <el-icon class="el-icon--right">
                        <arrow-down />
                    </el-icon>
                    </span>
                    <template #dropdown>
                    <el-dropdown-menu>
                        <el-dropdown-item>个人中心</el-dropdown-item>
                        <el-dropdown-item divided @click="handleLogout">退出登录</el-dropdown-item>
                    </el-dropdown-menu>
                    </template>
                </el-dropdown>
            </div>
        </div>
    </div>
</template>

<script setup lang="ts" name="Header">
    import router from '@/router'
    import {logout} from '@/api/auth'
    import {ref} from 'vue'
    // 先使用假数据开发页面。将来会从pinia中获取用户数据（头像和昵称）。
    const avatar = ref('https://himg.bdimg.com/sys/portraitn/item/public.1.fc4cce31.XtVbJS1kKdVpCfCbNXODUw')
    const nickname = ref('张三')
    
    // 退出登录的方法
    function handleLogout() {
        // 调用logout方法
        logout().then((res) => {
            if (res.data.code == 200) {
                // 清除用户的相关数据
                window.localStorage.clear();
                window.sessionStorage.clear();
                // 跳转到登录页面
                router.push('/login');
            }
        })
    }

</script>

<style lang="scss" scoped>
.header_container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-sizing: border-box;
    height: 100%;

    .header_left { // 制作文字阴影效果
	    color: #b833ff;
        text-shadow: 0 8px 10px #db66ff;
        font-weight: bolder;
        text-align: center;
    }

    .header_right {
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-sizing: border-box;
        .avatar {
            cursor: pointer;
            margin-right: 12px;
            .avatar_img {
                width: 30px;
                height: 30px;
            }
        }
        .el-dropdown-link {
            cursor: pointer;
            display: flex;
            align-items: center;
            border: none;
            outline: none; // 去除边框
        }
    }
}
</style>
```

注意：我们还需要在`src/api/auth/index.ts`中添加退出登录的接口

```ts
// 退出登录接口
export function logout() {
    return request({
        url: 'auth/logout',
        method: 'POST'
    })
}
```

## 4. 主体页面

### 4.1 项目主页添加主体页面

修改项目主页`src/Layout/index.vue`，添加主体页面：

- 在script标签中引入`import Main from './Main/index.vue';`
- 将template标签中的`<el-main>Main</el-main>`替换为`<el-main><Main /></el-main>`

### 4.2 主体页面

- `src/Layout/Main/index.vue`

```vue
<template>
    <!-- 容器 -->
    <RouterView />
</template>

<script setup lang="ts" name="Main">
    import { RouterView } from 'vue-router';
</script>

<style lang="scss" scoped>

</style>
```

### 4.3 配置404错误页

- 在`src/router/index.ts`的路由规则constRouter中添加`错误路由`的配置：

```ts
  {
    path: '/:pathMatch(.*)*',
    name: 'not-found',
    component: () => import('../views/NotFoundView.vue')
  }
```

- 创建错误页`src/views/NotFoundView.vue`（以下是一个好看的404页面模板）

```vue
<template>
    <div class="wrapper">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1920 1080">
            <title>404</title>
            <g id="Layer_12 yellow-back-fig" data-name="Layer 12">
                <path class="cls-1" d="M600.87,872H156a4,4,0,0,0-3.78,4.19h0a4,4,0,0,0,3.78,4.19H600.87a4,4,0,0,0,3.78-4.19h0A4,4,0,0,0,600.87,872Z" />
                <rect class="cls-1" x="680.91" y="871.98" width="513.38" height="8.39" rx="4.19" ry="4.19" />
                <path class="cls-1" d="M1480,876.17h0c0,2.32,2.37,4.19,5.3,4.19h350.61c2.93,0,5.3-1.88,5.3-4.19h0c0-2.32-2.37-4.19-5.3-4.19H1485.26C1482.33,872,1480,873.86,1480,876.17Z" />
                <rect class="cls-1" x="492.21" y="920.64" width="249.8" height="8.39" rx="4.19" ry="4.19" />
                <path class="cls-1" d="M1549.14,924.84h0a4.19,4.19,0,0,0-4.19-4.19H1067.46a14.66,14.66,0,0,1,.35,3.21v1A4.19,4.19,0,0,0,1072,929h472.94A4.19,4.19,0,0,0,1549.14,924.84Z" />
                <path class="cls-1" d="M865.5,924.84h0a4.19,4.19,0,0,0,4.19,4.19h82.37a12.28,12.28,0,0,1-.19-2v-2.17a4.19,4.19,0,0,0-4.19-4.19h-78A4.19,4.19,0,0,0,865.5,924.84Z" />
                <rect class="cls-1" x="915.6" y="981.47" width="54.72" height="8.39" rx="4.19" ry="4.19" />
                <path class="cls-1" d="M730.33,985.67h0c0,2.32,4.23,4.19,9.44,4.19h104.3c5.22,0,9.44-1.88,9.44-4.19h0c0-2.32-4.23-4.19-9.44-4.19H739.78C734.56,981.47,730.33,983.35,730.33,985.67Z" />
                <rect class="cls-1" x="997.06" y="981.47" width="78.11" height="8.39" rx="4.19" ry="4.19" />

                <g id="round-conf">
                    <path class="cls-1 circle c1" d="M536.41,155.14a17.77,17.77,0,1,0,17.77,17.77A17.77,17.77,0,0,0,536.41,155.14Zm0,28.68a10.9,10.9,0,1,1,10.9-10.9A10.9,10.9,0,0,1,536.41,183.81Z" />
                    <path class="cls-1 circle c2" d="M1345.09,82.44a17.77,17.77,0,1,0,17.77,17.77A17.77,17.77,0,0,0,1345.09,82.44Zm0,28.68a10.9,10.9,0,1,1,10.9-10.9A10.9,10.9,0,0,1,1345.09,111.12Z" />
                    <path class="cls-1 circle c3" d="M70.12,363A17.77,17.77,0,1,0,87.89,380.8,17.77,17.77,0,0,0,70.12,363Zm0,28.68A10.9,10.9,0,1,1,81,380.8,10.9,10.9,0,0,1,70.12,391.7Z" />
                    <path class="cls-1 circle c4" d="M170.47,751.82a17.77,17.77,0,1,0,17.77,17.77A17.77,17.77,0,0,0,170.47,751.82Zm0,28.68a10.9,10.9,0,1,1,10.9-10.9A10.9,10.9,0,0,1,170.47,780.5Z" />
                    <path class="cls-1 circle c5" d="M1457.34,762.73a17.77,17.77,0,1,0,17.77,17.77A17.77,17.77,0,0,0,1457.34,762.73Zm0,28.68a10.9,10.9,0,1,1,10.9-10.9A10.9,10.9,0,0,1,1457.34,791.4Z" />
                    <path class="cls-1 circle c6" d="M1829.15,407.49a17.77,17.77,0,1,0,17.77,17.77A17.77,17.77,0,0,0,1829.15,407.49Zm0,28.68a10.9,10.9,0,1,1,10.9-10.9A10.9,10.9,0,0,1,1829.15,436.17Z" />
                </g>
            </g>
            <g id="fortyfour" data-name="Layer 2">
                <g class="four a">

                    <rect class="cls-2" x="233.74" y="391.14" width="120.71" height="466.29" rx="57.1" ry="57.1" transform="translate(918.39 330.19) rotate(90)" />

                    <rect class="cls-3" x="333.83" y="475.1" width="120.71" height="396.88" rx="60.36" ry="60.36" />

                    <rect class="cls-3" x="197.13" y="122.89" width="120.71" height="604.75" rx="60.36" ry="60.36" transform="translate(290.49 -70.78) rotate(35)" />

                </g>
                <g class="four b">
                    <rect class="cls-2" x="1558.84" y="391.91" width="120.71" height="466.29" rx="57.1" ry="57.1" transform="translate(2244.26 -994.14) rotate(90)" />


                    <rect class="cls-3" x="1658.92" y="475.87" width="120.71" height="396.88" rx="60.36" ry="60.36" />
                    <rect class="cls-3" x="1522.22" y="123.66" width="120.71" height="604.75" rx="60.36" ry="60.36" transform="translate(530.57 -830.68) rotate(35)" />

                </g>
                <path class="cls-3" id="ou" d="M956.54,168.2c-194.34,0-351.89,157.55-351.89,351.89S762.19,872,956.54,872s351.89-157.55,351.89-351.89S1150.88,168.2,956.54,168.2Zm0,584.49c-128.46,0-232.6-104.14-232.6-232.6s104.14-232.6,232.6-232.6,232.6,104.14,232.6,232.6S1085,752.69,956.54,752.69Z" />
            </g>
            <g id="umbrella" data-name="Layer 3">
                <g>
                    <circle class="cls-4" cx="1187.53" cy="240.3" r="7.66" transform="translate(236.36 990.8) rotate(-49.71)" />
                    <g>
                        <path class="cls-5" d="M1219.56,359.67l55,100.52c32.7-48.48-6.87-142.43-91.75-214.38-84.41-71.55-183-95.33-225.81-56l114.21,44.14Z" />
                        <path class="cls-6" d="M1182.79,245.81c-84.41-71.55-183-95.33-225.81-56l114.21,44.14Z" />
                        <polygon class="cls-7" points="1182.79 245.81 1071.19 233.91 1219.56 359.67 1182.79 245.81" />
                    </g>
                    <polygon class="cls-8" points="1180.91 409.02 1274.54 460.19 1219.56 359.67 1071.19 233.91 956.98 189.76 1021.95 274.29 1180.91 409.02" />
                    <g>
                        <rect class="cls-4" x="997.45" y="358.35" width="175.58" height="5.1" transform="translate(108.21 955.38) rotate(-49.71)" />
                        <rect class="cls-4" x="1028.09" y="399.36" width="21.46" height="32.27" rx="10.73" ry="10.73" transform="translate(515.04 -573.16) rotate(40.29)" />
                    </g>
                </g>
            </g>
            <g id="pillow" data-name="Layer 4">
                <path class="cls-1" d="M754,627.07c7,.54,12.92-2.82,13.35-7.59s-4.95-9.24-12-9.87a18.55,18.55,0,0,0-2.17,0l-74.9-81.64c0-.1,0-.19,0-.29,0-7.09-4-12.83-8.8-12.81s-8.75,5.77-8.73,12.87c0,0,0,.09,0,.13l-50.21,46.07h-.09c-7.06-.63-13.14,2.77-13.57,7.59s4.87,9.16,11.85,9.84l76.08,82.92s0,0,0,.06c0,7.09,4,12.83,8.8,12.81s8.65-5.66,8.71-12.65Z" />
                <path class="cls-9" d="M669.46,514.82c-4.77-.83-8.75,5.77-8.73,12.87,0,0,0,.09,0,.13l-50.21,46.07h-.09c-7.06-.63-13.14,2.77-13.57,7.59s4.87,9.16,11.85,9.84l76.08,82.92s0,0,0,.06c0,7.09,4,12.83,8.8,12.81s8.65-5.66,8.71-12.65C570.55,573,702.07,520.47,669.46,514.82Z" />
            </g>
            <g id="cup" data-name="Layer 7">
                <polygon class="cls-1" points="1173.69 748.21 1140.52 715.42 1195.79 647.35 1241.13 692.16 1173.69 748.21" />
                <polygon class="cls-8" points="1173.69 748.21 1140.52 715.42 1143.93 711.27 1177.81 744.75 1173.69 748.21" />
                <polygon class="cls-5" points="1194.68 731.46 1157.04 694.24 1183.8 661.7 1226.91 704.32 1194.68 731.46" />
                <g class="cls-10">
                    <path class="cls-8" d="M1176.32,667.78h0a4.19,4.19,0,0,1,4.19,4.19v33.54a0,0,0,0,1,0,0h-8.38a0,0,0,0,1,0,0V672a4.19,4.19,0,0,1,4.19-4.19Z" transform="translate(822.53 -628.67) rotate(44.67)" />
                    <path class="cls-8" d="M1172.73,709.7l23.58-23.85a4.19,4.19,0,0,1,5.92,0h0a4.19,4.19,0,0,1,0,5.92l-23.58,23.85Z" />
                    <path class="cls-8" d="M1185.11,722.09l23.58-23.85a4.19,4.19,0,0,1,5.92,0h0a4.19,4.19,0,0,1,0,5.92L1191.06,728Z" />
                </g>
                <path class="cls-5" d="M1197.85,660.5h45.69a5.7,5.7,0,0,1,5.7,5.7v8.32a0,0,0,0,1,0,0h-57.09a0,0,0,0,1,0,0v-8.32A5.7,5.7,0,0,1,1197.85,660.5Z" transform="translate(829.53 -667.66) rotate(45)" />
                <path class="cls-8" d="M1191.49,664.74h53.94a5.25,5.25,0,0,1,5.25,5.25v4.79a0,0,0,0,1,0,0h-64.44a0,0,0,0,1,0,0V670a5.25,5.25,0,0,1,5.25-5.25Z" transform="translate(822.83 -663.17) rotate(44.67)" />
            </g>
            <g id="clock" data-name="Layer 8">
                <circle class="cls-5" cx="847.7" cy="247.59" r="74.66" transform="translate(-32.91 314.05) rotate(-20.6)" />
                <circle class="cls-1" cx="847.7" cy="247.59" r="63.44" transform="translate(-32.91 314.05) rotate(-20.6)" />
                <rect class="cls-3 clock-hand-1" x="845" y="189.5" width="6.04" height="58" rx="3.02" ry="3.02" />
                <rect class="cls-3 clock-hand-2" x="845" y="209.5" width="6.04" height="38" rx="3.02" ry="3.02" transform="translate(1611.22 -230.4) rotate(130.4)" />
                <circle class="cls-3" cx="847.7" cy="247.59" transform="translate(-32.91 314.05) rotate(-20.6)" r="3" />
            </g>
            <g id="box" data-name="Layer 9">
                <g id="box-top">
                    <polygon class="cls-8" points="569.71 382.28 653.74 329.39 747.13 320.1 679.2 369.85 569.71 382.28"></polygon>
                    <polygon class="cls-5" points="691.95 367.2 570.87 392.34 565.32 383.35 687.8 357.45 691.95 367.2"></polygon>

                    <polygon class="cls-5" points="661.54 337.48 570.87 392.34 562.42 378.92 652.25 322.38 658.12 321.34 661.54 337.48"></polygon>
                    <polygon class="cls-7" points="661.54 337.48 570.87 392.34 562.42 378.92 652.25 322.38 658.12 321.34 661.54 337.48"></polygon>
                    <polygon class="cls-5" points="747.13 320.1 661.54 337.48 652.25 322.38 738.4 307.1 747.13 320.1"></polygon>
                </g>
                <path class="cls-5" d="M588.28,420.26s3.44,5.2,5.19,8l43.1,68.48,158.81-100-43.1-68.48q-2.63-4.17-5.47-8Z"></path>
                <path class="cls-7" d="M588.28,420.26s3.44,5.2,5.19,8l43.1,68.48,158.81-100-43.1-68.48q-2.63-4.17-5.47-8Z"></path>
                <rect class="cls-5" x="693.73" y="335.51" width="83.99" height="90.58" transform="translate(-89.78 450.43) rotate(-32.19)"></rect>



            </g>

            <g id="rucksack" data-name="Layer 6">
                <g id="stripe">
                    <path class="cls-12" d="M1200.32,473.91h0a13.74,13.74,0,0,0-18.41,7.44l-55,129.86a14.82,14.82,0,0,0,7.13,19.21h0a13.74,13.74,0,0,0,18.41-7.44l55-129.86A14.82,14.82,0,0,0,1200.32,473.91Z" />
                    <path class="cls-13" d="M1202.18,606.34h0a14,14,0,0,0-16.18-11.8l-48.83,9c-7.59,1.4-12.66,9-11.31,16.89h0a14,14,0,0,0,16.18,11.8l48.83-9C1198.46,621.82,1203.53,614.26,1202.18,606.34Z" />
                </g>
                <path class="cls-8" d="M1300.86,603l-122.93,22.74-15.44-90.91c-5.75-33.86,15.89-66.17,48.34-72.18l11.58-2.08c32.45-6,57.26,17.66,63,51.51Z" />
                <path class="cls-1" d="M1307,601.91l-112.32,20.78-15.9-93.61c-5.5-32.36,15.19-63.25,46.2-69h0c31-5.74,60.62,15.85,66.12,48.21Z" />
                <path class="cls-8" d="M1296.76,603.8,1215,618.92l-4.89-28.77c-2.11-12.42,5.83-24.27,17.73-26.47l38.67-7.15c11.9-2.2,23.26,6.08,25.37,18.5Z" />
                <path class="cls-5" d="M1296.76,603.8l-73.41,13.58-4.92-29c-2-11.62,5.45-22.72,16.6-24.78l33.07-6.12c11.14-2.06,21.77,5.69,23.75,17.32Z" />
                <path class="cls-4" d="M1231.77,469.69l-13.42,2.48a10.25,10.25,0,0,0-8,11.92l2.38,14a9.9,9.9,0,0,0,11.42,8.33l13.42-2.48a10.25,10.25,0,0,0,8-11.92l-2.38-14A9.9,9.9,0,0,0,1231.77,469.69Zm7.17,20.84a6.39,6.39,0,0,1-5,7.43l-8.36,1.55a6.17,6.17,0,0,1-7.12-5.19l-1.48-8.73a6.39,6.39,0,0,1,5-7.43l8.36-1.55a6.17,6.17,0,0,1,7.12,5.19Z" />
                <path class="cls-14" d="M1233.74,471.13l-13.42,2.48a10.25,10.25,0,0,0-8,11.92l2.38,14a9.9,9.9,0,0,0,11.42,8.33l13.42-2.48a10.25,10.25,0,0,0,8-11.92l-2.38-14A9.9,9.9,0,0,0,1233.74,471.13Zm7.17,20.84a6.39,6.39,0,0,1-5,7.43l-8.36,1.55a6.17,6.17,0,0,1-7.12-5.19L1219,487a6.39,6.39,0,0,1,5-7.43l8.36-1.55a6.17,6.17,0,0,1,7.12,5.19Z" />
            </g>
            <g id="bike" data-name="Layer 5">
                <path class="cls-8 wheel" d="M1139.82,780.44a76.59,76.59,0,1,0-57.9,91.53A76.59,76.59,0,0,0,1139.82,780.44Zm-28.12,6.33a47.59,47.59,0,0,1,.83,15.8c-30.14-6.28-47.68-21.65-54.39-52.52A47.73,47.73,0,0,1,1111.69,786.77Zm-70.46-30.9c10.35,26.88,10.14,50.4-13.73,70.77a47.67,47.67,0,0,1,13.73-70.77Zm34.35,88a47.55,47.55,0,0,1-34.94-5.62c16.8-20.36,41.71-25.94,67.09-19.46A47.66,47.66,0,0,1,1075.58,843.85Z" />
                <path class="cls-8 wheel" d="M864.89,789.69a76.59,76.59,0,1,0-66.13,85.78A76.59,76.59,0,0,0,864.89,789.69Zm-28.59,3.7a47.59,47.59,0,0,1-.64,15.81c-29.43-9-45.47-26-49.3-57.33A47.73,47.73,0,0,1,836.3,793.39ZM769,756.1c7.82,27.72,5.43,51.12-20.22,69.2A47.67,47.67,0,0,1,769,756.1Zm26.06,90.78a47.55,47.55,0,0,1-34.27-8.83c18.61-18.72,43.93-22,68.6-13.16A47.66,47.66,0,0,1,795.06,846.88Z" />
                <g>
                    <rect class="cls-1" x="871.39" y="693.37" width="12.87" height="53.21" transform="translate(-165.97 273.38) rotate(-16.19)" />
                    <path class="cls-5" d="M813.93,679.35c-3.72-5.2,2.24-18.5,9.16-16.13,33.43,11.46,73.85,10.45,73.85,10.45,8.84.15,14.44,10.34,7.27,15.48-14.36,8.79-33.13,17-56.35,9.76C830.17,693.41,819.83,687.6,813.93,679.35Z" />
                    <path class="cls-7" d="M813.93,679.35c-3.72-5.2,2.24-18.5,9.16-16.13,33.43,11.46,73.85,10.45,73.85,10.45,8.84.15,14.44,10.34,7.27,15.48-14.36,8.79-33.13,17-56.35,9.76C830.17,693.41,819.83,687.6,813.93,679.35Z" />
                    <path class="cls-5" d="M817.15,680.06c-3.59-5,1.69-16.51,8.37-14.22,32.3,11.09,71.41,7.83,71.41,7.83,8.54.14,17.45,9.94,7.43,15.88-13.87,8.51-32,16.44-54.44,9.44C832.84,693.67,822.85,688,817.15,680.06Z" />
                </g>
                <g>
                    <circle class="cls-9" cx="1022.66" cy="599.55" r="11.57" transform="translate(-4.86 8.38) rotate(-0.47)" />
                    <path class="cls-1" d="M1069.76,792.37l-34.89-96.74,1.93-.8-1.71-4.15-1.74.72-13.26-36.76,1.27-.42-2.25-6.76,5.94-2-2.57-7.72-9.7,3.22c-11.55-22.55,2-36.33,15-41.86l-5.57-8.81c-23,10.29-29.61,28.75-19.53,54l-9.38,3.12,2.56,7.72,5.47-1.82,2.25,6.76,2.36-.78,13.62,37.76-2.35,1,1.71,4.15,2.16-.89,34.65,96.09a7.47,7.47,0,0,0,9.56,4.49h0A7.47,7.47,0,0,0,1069.76,792.37Z" />
                    <circle class="cls-11" cx="1027.9" cy="587.94" r="12.99" transform="translate(-4.77 8.42) rotate(-0.47)" />
                </g>
                <path class="cls-5" d="M1021.29,654l-17.73,6.15,1.72,5.59-31.41,82.36c-19.35,32.53-66.3,36.72-75.56,16.68l-7.09-21.5L879,747.1l3.28,10.09-94.65,33.95c-11.49,2.29-11.85,15.79-2.61,17.84,0,0,39.11,3.66,103,9.5a92.75,92.75,0,0,0,40.89-5.29c44.32-16.56,57.73-50.67,57.73-50.67l26.82-67.26a1.37,1.37,0,0,1,2.53,0l1.42,3.33,17.75-7.62Z" />
                <path class="cls-7" d="M1021.29,654l-17.73,6.15,1.72,5.59-31.41,82.36c-19.35,32.53-66.3,36.72-75.56,16.68l-7.09-21.5L879,747.1l3.28,10.09-94.65,33.95c-11.49,2.29-11.85,15.79-2.61,17.84,0,0,39.11,3.66,103,9.5a92.75,92.75,0,0,0,40.89-5.29c44.32-16.56,57.73-50.67,57.73-50.67l26.82-67.26a1.37,1.37,0,0,1,2.53,0l1.42,3.33,17.75-7.62Z" />
            </g>
        </svg>
    </div>
</template>

<script setup lang="ts" name="NotFoundView">

</script>

<style lang="scss" scoped>
.cls-1 {
  fill: #ffc541;
}

.cls-2 {
  fill: #4e4066;
}

.cls-3 {
  fill: #6f5b92;
}

.cls-4 {
  fill: #f78d5e;
}

.cls-5 {
  fill: #fa976c;
}

.cls-6,
.cls-7,
.cls-8 {
  fill: #b65c32;
}

.cls-10,
.cls-6 {
  opacity: 0.6;
}

.cls-7 {
  opacity: 0.4;
}

.cls-9 {
  fill: #f4b73b;
}

.cls-11 {
  fill: #f9c358;
}

.cls-12 {
  fill: #9b462c;
}

.cls-13 {
  fill: #aa512e;
}

.cls-14 {
  fill: #7d6aa5;
}


/* animations */

.wheel {
  animation: wheel-rotate 6s ease infinite;
  transform-origin: center;
  transform-box: fill-box;
}

@keyframes wheel-rotate {
  50% {
    transform: rotate(360deg);
    animation-timing-function: cubic-bezier(0.55, 0.085, 0.68, 0.53);
  }
  100% {
    transform: rotate(960deg)
  }
}

.clock-hand-1 {
  animation: clock-rotate 3s linear infinite;
  transform-origin: bottom;
  transform-box: fill-box;
}

.clock-hand-2 {
  animation: clock-rotate 6s linear infinite;
  transform-origin: bottom;
  transform-box: fill-box;
}

@keyframes clock-rotate {
  100% {
    transform: rotate(360deg)
  }
}

#box-top {
  animation: box-top-anim 2s linear infinite;
  transform-origin: right top;
  transform-box: fill-box;
}

@keyframes box-top-anim {
  50% {
    transform: rotate(-5deg)
  }
}

#umbrella {
  animation: umbrella-anim 6s linear infinite;
  transform-origin: center;
  transform-box: fill-box;
}

@keyframes umbrella-anim {
  25% {
    transform: translateY(10px) rotate(5deg);
  }
  75% {
    transform: rotate(-5deg);
  }
}

#cup {
  animation: cup-rotate 3s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
  transform-origin: top left;
  transform-box: fill-box;
}

@keyframes cup-rotate {
  50% {
    transform: rotate(-5deg)
  }
}

#pillow {
  animation: pillow-anim 3s linear infinite;
  transform-origin: center;
  transform-box: fill-box;
}

@keyframes pillow-anim {
  25% {
    transform: rotate(10deg) translateY(5px)
  }
  75% {
    transform: rotate(-10deg)
  }
}

#stripe {
  animation: stripe-anim 3s linear infinite;
  transform-origin: center;
  transform-box: fill-box;
}

@keyframes stripe-anim {
  25% {
    transform: translate(10px, 0) rotate(-10deg)
  }
  75% {
    transform: translateX(10px)
  }
}

#bike {
  animation: bike-anim 6s ease infinite;
}

@keyframes bike-anim {
  0% {
    transform: translateX(-1300px)
  }
  50% {
    transform: translateX(0);
    animation-timing-function: cubic-bezier(0.47, 0, 0.745, 0.715);
  }
  100% {
    transform: translateX(1300px)
  }
}

#rucksack {
  animation: ruck-anim 3s linear infinite;
  transform-origin: top;
  transform-box: fill-box;
}

@keyframes ruck-anim {
  50% {
    transform: rotate(5deg)
  }
}

.circle {
  animation: circle-anim ease infinite;
  transform-origin: center;
  transform-box: fill-box;
  perspective: 0px;
}

.circle.c1 {
  animation-duration: 2s
}

.circle.c2 {
  animation-duration: 3s
}

.circle.c3 {
  animation-duration: 1s
}

.circle.c4 {
  animation-duration: 1s
}

.circle.c5 {
  animation-duration: 2s
}

.circle.c6 {
  animation-duration: 3s
}

@keyframes circle-anim {
  50% {
    transform: scale(.2) rotateX(360deg) rotateY(360deg)
  }
}

.four,
#ou {
  animation: four-anim cubic-bezier(0.39, 0.575, 0.565, 1) infinite;
}

.four.a {
  transform-origin: bottom left;
  animation-duration: 3s;
  transform-box: fill-box;
}

.four.b {
  transform-origin: bottom right;
  animation-duration: 3s;
  transform-box: fill-box;
}

#ou {
  animation-duration: 6s;
  transform-origin: center;
  transform-box: fill-box;
}

@keyframes four-anim {
  50% {
    transform: scale(.98)
  }
}
</style>
```

### 4.4 动态路由

- 我们先写一个路由组件`src/views/index.vue`

```vue
<template>
    <div>
        我是首页
    </div>
</template>

<script setup lang="ts" name="index">

</script>

<style lang="scss" scoped>

</style>
```

- 接下来删除`src/router/index.ts`路由规则中的以下内容（因为我们将使用路由守卫实现动态路由）

```ts
import Layout from '@/Layout/index.vue'

  {
    path: '/home',
    name: 'home',
    component: Layout
  }
```

- 修改`src/stores/menu.ts`，实现动态路由

```ts
import {defineStore} from 'pinia';
import {searchSelfRouter} from '@/api/user';

export const useMenuStore = defineStore('menu', {
    // 定义数据
    state: () => ({
        menuList: [],
        routerList: [], // 动态路由数据，也就是左侧菜单的路由信息
    }),
    // 获取数据的方法
    getters: {

    }, 
    // 操作数据的方法
    actions: {
        setMenuList(data) {
            console.log("setMenuList=======>", data);
            this.menuList = data;
        },

        // 根据menuList渲染动态路由，存储到routerList中，这样动态路由就与pinia有相同的生命周期
        // 注意，routerList不要持久化，因为其中的component无法保存为string的形式，而我们会对menuList进行持久化
        // 如果手动刷新页面则会清除pinia中的数据，此时需要根据menuList重新渲染动态路由
        setRouterList() {
            this.menuList.forEach(item => {
                let routerInfo = {
                    name: item.menuName,
                    path: item.path,
                    meta: {title: item.menuName},
                    // 设置组件
                    component: () => import(/*@vite-ignore */`../views/${item.path}.vue`)
                }
                // 将路由信息添加到routerList中
                this.routerList.push(routerInfo);
                
                // 设置子菜单
                let childrenList = item.children;
                childrenList.forEach(children => {
                    let routerInfo = {
                        name: children.menuName,
                        path: children.path,
                        meta: {title: children.menuName},
                        component: () => import(/*@vite-ignore */`../views/${children.path}.vue`)
                    }
                    this.routerList.push(routerInfo)
                })
            })
        }
    }
})
```

- 创建路由守卫`src/router/permission.ts`

```ts
import router from '@/router'
import { useMenuStore } from '@/stores/menu'
import Layout from '@/Layout/index.vue'

// 设置路由白名单
const whiteRouter = ['/', '/login', '/error', '/404']
// 标志，用于判断否已经添加动态路由，避免重复添加
let isAddRoutes = false

// 全局前置路由守卫
router.beforeEach(async (to, from) => {
    // 如果to在路由白名单中，或者已经添加过动态路由，则直接放行
    if (whiteRouter.indexOf(to.path) != -1 || isAddRoutes)
        return true;

    // 如果routerList中还没有动态路由的数据，则进行设置
    const menuStore = useMenuStore();
    if (menuStore.routerList.length == 0)
        await menuStore.setRouterList();

    // 添加动态路由
    // 所有的页面都是加载到Layout/Main组件的RouterView中
    // 相当于所有的路由都是Layout的子路由
    const routerList = menuStore.routerList;
    router.addRoute(
        {
            component: Layout,
            path: "/home",
            children: routerList
        }
    )

    // 动态路由添加完毕，设置标志为true
    isAddRoutes = true;
    // 返回to.fullPath，当添加完所有动态路由后，触发重定向
    return to.fullPath;
})
```

- 在`main.ts`中导入路由守卫

```ts
import './router/permission'
```

- 除此之外，还要根据数据库中`ums_menu`表的`path`字段创建对应的组件
  - `src/views/system/user/index.vue`
  - `src/views/system/role/index.vue`
  - `src/views/system/menu/index.vue`

### 4.5 tabs开发

- 修改`src/Layout/Main/index.vue`

```vue
<template>
    <el-tabs
        v-model="activeTab"
        type="card"
        closable
        class="demo-tabs"
        @tab-change="gotoTab"
        @tab-remove="closeTab"
    >
        <el-tab-pane
            v-for="item in tabList"
            :key="item.path"
            :label="item.title"
            :name="item.path"
        >
            <!-- 容器 -->
            <RouterView/>
        </el-tab-pane>
    </el-tabs>
</template>

<script setup lang="ts" name="Main">
    import { RouterView } from 'vue-router';
    // TODO: 从MenuStore中获取tab的数据
</script>

<style lang="scss" scoped>

</style>
```

- 在`src/stores/menu.ts`中增加tabs相关的操作

```ts
export const useMenuStore = defineStore('menu', {
    state: () => ({
        menuList: [],
        routerList: [], // 动态路由数据，也就是左侧菜单的路由信息
        tabList: [], // 所有的tab
        activeTab: null // 当前选中的tab
    }),
	...
    actions: {
		...,
        // 设置tabList
        setTabList(data) {
            this.tabList.push(data);
        },
        // 删除tabList（根据path）
        delTabList(path) {
            this.tabList = this.tabList.filter(item => {
                return item.path != path;
            })
        },
        // 设置activeTab
        setActive(path) {
            this.activeTab = path;
        }
    }
})
```

- 在`src/Layout/Aside/index.vue`的`script`代码中修改切换路由的点击事件

```ts
    // 切换路由
    function handleRouter(menu) {
        // 向tabList中添加数据，已经添加过的tab就不需要再添加了
        // tab的结构：{title: '首页', path: 'index'}
        let hasNode = menuStore.tabList.filter(item => item.path == menu.path);
        if (hasNode == null || hasNode.length == 0) {
            let data = {title: menu.menuName, path: menu.path};
            menuStore.setTabList(data);
        }
        // 修改activeTab的值
        menuStore.setActive(menu.path);
        router.push('/home/' + menu.path);
    }
```

- 完善`src/Layout/Main/index.vue`中的`script`代码

```ts
<script setup lang="ts" name="Main">
    import { RouterView } from 'vue-router';
    // 从MenuStore中获取tab的数据
    import { useMenuStore } from '@/stores/menu';
    import { storeToRefs } from 'pinia';
    import { useRouter } from 'vue-router';
    const router = useRouter();
    const menuStore = useMenuStore();
    let { tabList, activeTab } = storeToRefs(menuStore);
    
    // 选中tab
    function gotoTab(path) {
        // 修改activeTab
        menuStore.setActive(path);
        // 路由页面
        router.push('/home/' + path);
    }
    // 移除tab
    function closeTab(path) {
        menuStore.delTabList(path);
        // 如果移除的是当前激活的tab，则需要激活另一个tab
        if (path == menuStore.activeTab) {
            if (tabList.value == null || tabList.value.length == 0) {
                menuStore.setActive(null);
                router.push('/home');
            } else {
                let newPath = tabList.value[tabList.value.length - 1].path;
                menuStore.setActive(newPath);
                router.push('/home/' + newPath);
            }
        }
    }
</script>
```

## 5. 配置pinia持久化

- 安装依赖

```powershell
npm install pinia-plugin-persistedstate
```

- `main.ts`中添加配置

```ts
import piniaPluginPersistedstate from 'pinia-plugin-persistedstate'

// 将app.use(createPinia())替换成以下代码
const pinia = createPinia();
pinia.use(piniaPluginPersistedstate);
app.use(pinia);
```

- 使用持久化，在`menu.ts`的`defineStore()`中添加一个字段来持久化所需的数据：

```ts
export const useMenuStore = defineStore('menu', {
    state: ... ,
    getters: ... , 
    actions: ... ,
    // 使用持久化
    persist: {
    	enabled: true,
        storage: localStorage,
        key: 'useMenu',
        paths: ['menuList', 'tabList', 'activeTab']
    }
})
```

# 第05章_用户模块开发

## 1. 后端查询用户信息

### 1.1 实体类

返回给前端的数据UserInfoVO，包括用户id、昵称、头像。包名`com.thuwsy.aoyou.user.domain.vo`

```java
@Data
public class UserInfoVO implements Serializable {
    private Long id;
    private String nickname;
    private String avatar;
}
```

### 1.2 controller

包名`com.thuwsy.aoyou.user.controller`

```java
@RestController
@RequestMapping("/sys/user")
public class UserController {
    @Autowired
    private IUserService userService;
    
    @GetMapping("/info")
    public CommonResult searchUserInfo() {
        return CommonResult.success(userService.searchUserInfo());
    }
}
```

### 1.3 service

包名`com.thuwsy.aoyou.user.service`

```java
public interface IUserService {
    UserInfoVO searchUserInfo();
}
```

包名`com.thuwsy.aoyou.user.service.impl`

```java
@Service
public class UserServiceImpl implements IUserService {
    @Override
    public UserInfoVO searchUserInfo() {
        // 通过SecurityContext获取已登录的用户信息
        LoginUserVO loginUser = SecurityUtil.getLoginUser();
        UmsSysUser user = loginUser.getSysUser();
        if (ObjectUtil.isNull(user)) {
            throw new ServiceException(HttpStatus.UNAUTHORIZED, "用户未登录");
        }

        UserInfoVO userInfoVO = new UserInfoVO();
        BeanUtil.copyProperties(user, userInfoVO);
        return userInfoVO;
    }
}
```

## 2. 前端存储用户信息

- 在pinia中存储用户信息，`src/stores/user.ts`

```ts
import { defineStore } from 'pinia'

export const useUserStore = defineStore('user', {
    state: () => ({ 
        id: undefined,
        nickname: undefined,
        avatar: undefined,
    }),
    getters: {

    },
    actions: {
        setUserInfo(data) {
            this.id = data.id;
            this.nickname = data.nickname;
            this.avatar = data.avatar;
        }
    },
    // 使用持久化
    persist: {
    	enabled: true,
        storage: localStorage,
        key: 'userInfo',
        paths: ['id', 'nickname', 'avatar']
    }
})
```

- 修改`Login.vue`中的script代码（发起请求，查询用户信息）

```ts
    import {searchSelfRouter, searchSelfInfo} from '@/api/user';
	import {useUserStore} from '@/stores/user';
	const userStore = useUserStore();
	...
    // 登录方法
    function handleLogin() {
        // 调用login方法
        login(loginForm.value).then((res) => {
            console.log('登录===>', res);
            if (res.data.code == 200) {
                // 1. 将token存储到localStorage中
                setToken("aoyouToken", res.data.token);
                
                // 2. 查询用户的昵称和头像，存储到pinia中
                searchSelfInfo().then(res => {
                    if (res.data.code == 200)
                        userStore.setUserInfo(res.data.data);
                })

                // 3. 查询用户的菜单权限，存储到pinia中
                searchSelfRouter().then(res => {
                    if (res.data.code == 200)
                        menuStore.setMenuList(res.data.data);
                })

                // 4. 跳转页面
                router.push("/home")
            }
        })
    }
```

- 修改`src/Layout/Header/index.vue`，将script代码中`avatar`和`nickname`的假数据替换成以下代码

```ts
    import { useUserStore } from '@/stores/user';
    import { storeToRefs } from 'pinia';
    const userStore = useUserStore();
    let { avatar, nickname } = storeToRefs(userStore);
```

## 3. 菜单管理页面开发

### 3.1 整体页面

`src/views/system/menu/index.vue`

```vue
<template>
    <!-- 头部搜索框 -->
    <el-form :model="queryForm" :inline="true">
        <el-form-item label="菜单名称">
            <el-input v-model="queryForm.menuName" />
        </el-form-item>
        <el-form-item label="权限名称">
            <el-input v-model="queryForm.perms" />
        </el-form-item>
        <el-form-item>
            <el-button type="primary" @click="handleQuery">搜索</el-button>
            <el-button @click="handleRest">重置</el-button>
        </el-form-item>
    </el-form>

    <!-- 功能按钮 -->
    <el-row :gutter="4">
        <el-col :span="6">
            <el-button type="primary" @click="handleAdd">新增</el-button>
            <el-button type="danger" @click="handleRemove(0)">删除</el-button>
        </el-col>
    </el-row>

    <!-- 列表 -->
    <el-table :data="menuList" style="width: 100%" row-key="id" default-expand-all @selection-change="handleSelectionChange">
        <el-table-column type="selection" width="55" />
        <el-table-column type="index" label="序号" width="55" />
        <el-table-column prop="menuName" label="菜单名称" width="200" />
        <el-table-column prop="perms" label="权限标识" width="200" />
        <el-table-column prop="path" label="路由地址" width="200" />
        <el-table-column prop="componentPath" label="组件名称" width="200" />
        <!-- <el-table-column prop="createTime" label="创建时间" width="200" /> -->
        <!-- <el-table-column prop="updateTime" label="修改时间" width="200" /> -->
        <el-table-column prop="remark" label="备注" width="200" />
        <el-table-column label="操作" width="200">
            <template #default="scope">
                <el-button link type="success" size="small" @click="handleEdit(scope.row.id)">修改</el-button>
                <el-button link type="danger" size="small" @click="handleRemove(scope.row.id)">删除</el-button>
            </template>
        </el-table-column>
    </el-table>

    <!-- 分页 -->
    <div class="pagination_container">
        <el-pagination v-model:current-page="queryForm.pageNum" v-model:page-size="queryForm.pageSize"
            :page-sizes="[10, 20, 30, 40, 50]" layout="total, sizes, prev, pager, next, jumper" :total="total"
            @size-change="handleSizeChange" @current-change="handleCurrentChange" />
    </div>

    <!-- 新增和修改的弹窗 -->
    <el-dialog v-model="menuFormShow" :title="menuTitle" width="50%" :before-close="handleClose">
        <!-- 表单 -->
        <el-form :model="form" label-width="120px">
            <el-row>
                <el-col :span="12">
                    <el-form-item label="上级菜单" prop="form.parentId">
                        <el-tree-select check-strictly v-model="form.parentId" :data="menuSelectData" :render-after-expand="false" placeholder="请选择上级菜单"/>
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="菜单类型" prop="form.menuType">
                        <el-select v-model="form.menuType" class="m-2" placeholder="请选择菜单类型">
                            <el-option
                                v-for="item in menuTypeOptions"
                                :key="item.value"
                                :label="item.label"
                                :value="item.value"
                            />
                        </el-select>
                    </el-form-item>
                </el-col>
            </el-row>
           
            <el-row>
                <el-col :span="12">
                    <el-form-item label="菜单图标" prop="form.icon">
                        <el-popover
                            placement="bottom-start"
                            :width="460"
                            trigger="click"
                        >
                            <template #reference>
                                <!-- 通过插槽实现图标选择，默认是一个有图标的输入框 -->
                                <el-input v-model="form.icon" placeholder="请选择图标">
                                    <template #prefix>
                                        <!-- 判断是否选中了icon -->
                                        <svg-icon
                                            v-if="form.icon"
                                            slot="prefix"
                                            :name="form.icon"
                                            width="16px"
                                            height="16px"
                                        />
                                        <!-- 如果未选中，显示默认的搜索图标 -->
                                        <el-icon v-else class="el-input__icon"><search /></el-icon>
                                    </template>
                                </el-input>
                            </template>
                            <!-- 显示选择图标的组件 -->
                            <IconSelect ref="iconSelect" @selected="handleSelect" :active-icon="form.icon"/>
                        </el-popover>
                        
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="菜单名称" prop="form.menuName">
                        <el-input v-model="form.menuName" placeholder="请输入菜单名称"/>
                    </el-form-item>
                </el-col>
            </el-row>

            <el-row>
                <el-col :span="12">
                    <el-form-item label="排序" prop="form.sort">
                        <el-input-number :min="0" v-model="form.sort"/>
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="路由地址" prop="form.path">
                        <el-input v-model="form.path" placeholder="请输入路由地址"/>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="12">
                    <el-form-item label="组件名称" prop="form.componentPath">
                        <el-input v-model="form.componentPath" placeholder="请输入组件名称"/>
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="权限标识" prop="form.perms">
                        <el-input v-model="form.perms" placeholder="请输入权限标识"/>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="12">
                    <el-form-item label="状态" prop="form.status">
                        <el-switch
                            v-model="form.status"
                            active-text="可用"
                            inactive-text="不可用"
                            :active-value="0"
                            :inactive-value="1"
                        />
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="备注" prop="form.remark">
                        <el-input v-model="form.remark" placeholder="请输入备注"/>
                    </el-form-item>
                </el-col>
            </el-row>
        </el-form>

        <template #footer>
            <span class="dialog-footer">
                <el-button @click="menuFormShow = false">取消</el-button>
                <el-button type="primary" @click="handleSubmit">提交</el-button>
            </span>
        </template>
    </el-dialog>
</template>

<script setup lang="ts" name="menu">
    import { ref, onMounted } from 'vue';
    // 导入图标选择组件
    import IconSelect from '@/components/IconSelect/index.vue';
    // 导入消息提示
    import { ElMessage, ElMessageBox  } from 'element-plus';
    // 导入菜单接口
    import { searchMenuList,saveMenu,updateMenu,searchMenuById,removeMenu } from '@/api/menu';

    /* 数据 */

    let total = ref(0); // 一共有几条数据
    let selectIds = ref([]); // 多选选中的数据
    let menuFormShow = ref(false); // 新增菜单的弹窗是否显式，默认不显示
    let menuTitle = ref(""); // 弹窗的名称：新增菜单/修改菜单
    
    // 头部搜索框的数据
    let queryForm = ref({
        menuName: undefined,
        perms: undefined,
        pageNum: 1,
        pageSize: 10
    })
    // 弹窗表单数据
    let form = ref({
        id: undefined,
        parentId: undefined,
        menuName: undefined,
        path: undefined,
        componentPath: undefined,
        perms: undefined,
        icon: undefined,
        menuType: 0,
        sort: 0,
        status: 0,
        remark: '',
    })

    // 树形选择器
    let menuSelectData = ref([])
    // 菜单类型选择器
    let menuTypeOptions = ref([
        {
            value: 0,
            label: "目录"
        },
        {
            value: 1,
            label: "菜单"
        },
        {
            value: 2,
            label: "按钮"
        }
    ])

    // 菜单数据列表
    let menuList = ref([]);

    /* 挂载时，查询所有菜单 */
    onMounted(() => {
        handleSearchMenuList();
    })
    // 查询所有菜单
    function handleSearchMenuList() {
        searchMenuList(queryForm.value).then(res => {
            if (res.data.code == 200) {
                // 获取数据
                menuList.value = res.data.data.list;
                total.value = res.data.data.total;
                let menuSelect = []; 
                // 添加一个根目录，所有的菜单都是根目录的子菜单
                menuSelect.push({label: '主目录', value: 0, children: []})
                // 循环查出来的数据
                for (const item of res.data.data.list) {
                    let label = item.menuName;
                    let value = item.id;
                    let childrenList = [];
                    // 判断是否有子菜单
                    if(item.children.length > 0) {
                        for (const childrenItem of item.children) {
                            let label = childrenItem.menuName;
                            let value = childrenItem.id;
                            let children = {label: label,value: value}
                            childrenList.push(children)
                        }
                    }
                    let menu = {label: label, value: value, children: childrenList}
                    menuSelect[0].children.push(menu);
                }
                menuSelectData.value = menuSelect;
            }
        })
    }


    /* 头部搜索框相关方法 */

    // 搜索
    function handleQuery() {
        queryForm.value.pageNum = 1;
        queryForm.value.pageSize = 10;
        searchMenuList(queryForm.value).then(res => {
            if (res.data.code == 200) {
                // 获取数据
                menuList.value = res.data.data.list;
                total.value = res.data.data.total;
            }
        })
    }

    // 重置
    function handleRest() {
        queryForm.value.pageNum = 1;
        queryForm.value.pageSize = 10;
        queryForm.value.menuName = undefined;
        queryForm.value.perms = undefined;
        searchMenuList(queryForm.value).then(res => {
            if (res.data.code == 200) {
                // 获取数据
                menuList.value = res.data.data.list;
                total.value = res.data.data.total;
            }
        })
    }

    /* 功能按钮相关方法 */
    
    // 新增按钮（弹出表单即可）
    function handleAdd() {
        form.value.id = undefined;
        menuFormShow.value = true;
        menuTitle.value = "新增菜单";
    }

    // 删除按钮，弹出是否要删除数据，确定就删除，取消就不删除
    function handleRemove(id) {
        // ids是要删除的菜单id列表
        let ids = undefined; 
        if (id > 0) {
            ids = [id]
        } else {
            if (selectIds.value.length == 0)
                return;
            ids = selectIds.value;
        }

        ElMessageBox.confirm(
            `确定要删除这些数据吗?`,
            '删除菜单',
            {
                confirmButtonText: '确定',
                cancelButtonText: '取消',
                type: 'warning'
            }
        ).then(() => {
            removeMenu(ids).then(res => {
                if (res.data.code == 200) {
                    ElMessage.success('删除成功');
                    // 刷新列表
                    handleSearchMenuList();
                }
            })
        }).catch(() => {})
    }
    /* 列表相关方法 */

    // 修改按钮（首先根据id查询对应的菜单数据，然后弹出表单并回显数据）
    function handleEdit(id) {
        // 先查询数据，再弹窗
        searchMenuById(id).then(res => {
            if (res.data.code == 200) {
                // 保证后端返回的字段名和前端字段名相同，就可以一一对应赋值
                form.value = res.data.data;
                menuFormShow.value = true;
                menuTitle.value = "修改菜单";
            } else {
                ElMessage.error('数据查询失败')
            }
        })
    }

    // 多选变化
    function handleSelectionChange(selection) {
        let ids = selection.map(item => item.id)
        selectIds.value = ids;
    }

    /* 分页相关方法 */

    function handleSizeChange(sizeNumber) {
        queryForm.value.pageSize = sizeNumber;
        searchMenuList(queryForm.value).then(res => {
            if (res.data.code == 200) {
                // 获取数据
                menuList.value = res.data.data.list;
                total.value = res.data.data.total;
            }
        })
    }

    // 点击下一页，上一页
    function handleCurrentChange(pageNumber) {
        queryForm.value.pageNum = pageNumber;
        searchMenuList(queryForm.value).then(res => {
            if (res.data.code == 200) {
                // 获取数据
                menuList.value = res.data.data.list;
                total.value = res.data.data.total;
            }
        })
    }

    /* 表单相关方法 */
    // 数据校验，如果字符串为空，则返回true
    function isStrBlank(data) {
        return data === undefined || data === null ||
            data == '' || data.trim() === '';
    }
    // 数据校验，如果数值为空，则返回true
    function isNumBlank(data) {
        return data === undefined || data === null;
    }

    // 提交表单，根据form.id值判断是新增还是修改【有id值则为修改】
    function handleSubmit() {
        // 做数据校验
        if (isNumBlank(form.value.parentId)) {
            ElMessage.warning('上级菜单不能为空');
            return;
        }
        if (isStrBlank(form.value.menuName)) {
            ElMessage.warning('菜单名称不能为空');
            return;
        }
        if (isStrBlank(form.value.path)) {
            ElMessage.warning('路由地址不能为空');
            return;            
        }
        if (isStrBlank(form.value.componentPath)) {
            ElMessage.warning('组件名称不能为空');
            return;            
        }
        if (isStrBlank(form.value.perms)) {
            ElMessage.warning('权限标识不能为空');
            return;            
        }
        if (isStrBlank(form.value.icon)) {
            ElMessage.warning('菜单图标不能为空');
            return;            
        }        

        if (form.value.id) {
            // 修改
            updateMenu(form.value).then(res => {
                if(res.data.code == 200) {
                    // 关闭窗口
                    menuFormShow.value = false;
                    // 刷新列表
                    handleSearchMenuList();
                    // 弹窗提示新增成功
                    ElMessage.success('修改菜单成功')
                }
            })
        } else {
            // 新增，调用新增接口
            saveMenu(form.value).then(res => {
                if (res.data.code == 200) {
                    // 关闭窗口
                    menuFormShow.value = false;
                    // 刷新列表
                    handleSearchMenuList();
                    // 弹窗提示新增成功
                    ElMessage.success('新增菜单成功')
                }
            })
        }
    }

    // 关闭弹窗
    function handleClose() {
        menuFormShow.value = false;
    }

    // 选择图标
    function handleSelect(name) {
        form.value.icon = name;
    }
</script>

<style lang="scss" scoped>
.pagination_container {
    position: relative;
    height: 40px;
    margin-top: 15px;
}

.el-pagination {
    position: absolute;
    right: 110px;
}
</style>
```

> 我们后续会补充添加其中引用的一些组件

### 3.2 国际化

修改`App.vue`实现国际化，这样分页条就是中文的

```vue
<template>
  <!-- 容器 -->
  <el-config-provider :locale="locale">
    <RouterView />
  </el-config-provider>
</template>

<script setup lang="ts">
  import { RouterView } from 'vue-router'
  import { ref } from 'vue'
  import { ElConfigProvider } from 'element-plus'
  import zhCn from 'element-plus/es/locale/lang/zh-cn'
  let locale = ref(zhCn)
</script>

<style scoped>

</style>
```

### 3.3 图标选择组件

- `src/components/IconSelect/requestIcon.ts`

```ts
const iconsVite = import.meta.glob('../../assets/icons/svg/*.svg')
// icon数组，最终导出
let icons = [];
// 正则表达式，匹配所有的svg文件
const re = /\.\/(.*)\.svg/
// 循环，根据正则表达式，匹配值图标
for (const icon in iconsVite) {
  // 只获取图标的名字
  let name = icon.match(re)[1].substring(icon.match(re)[1].lastIndexOf('/') + 1)
  icons.push(name)
}
export default icons
```

- `src/components/IconSelect/index.vue`

```vue
<template>
    <div class="icon-body">
        <!-- 头部输入框 -->
        <el-input v-model="name" class="icon-search" clearable placeholder="请输入图标名称" @clear="filterIcons" @input="filterIcons">
        <template #suffix>
            <el-icon class="el-input__icon"><search /></el-icon>
        </template>
        </el-input>
        <!-- 显示所有的icon和名字的容器 -->
        <div class="icon-list">
            <div class="list-container">
                <div v-for="(item, index) in iconList" class="icon-item-wrapper" :key="index" @click="selectedIcon(item)">
                    <div :class="['icon-item', { active: activeIcon === item }]">
                        <!-- 通过组件显示图标 -->
                        <svg-icon :name="item" width="16px" height="25px"></svg-icon>
                        <span>{{ item }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script setup lang="ts" name="IconSelect">
    import icons from './requestIcon'
    import { ref, defineProps, defineEmits } from 'vue';
    // 声明事件
    const emit = defineEmits(['selected'])

    defineProps({
        activeIcon: String
    })

    const name = ref();
    const iconList = icons;

    function filterIcons() {
        iconList.value = icons
        if (name.value) {
            iconList.value = iconList.value.filter(item => item.includes(name.value))
        }
    }

    function selectedIcon(name) {
        emit('selected',name)
        document.body.click()
    }

    function reset() {
        name.value = ''
        iconList.value = icons
    }
</script>

<style rel="stylesheet/scss" lang="scss" scoped>
.icon-body {
    width: 100%;
    padding: 10px;
    .icon-search {
        position: relative;
        margin-bottom: 5px;
    }
    .icon-list {
        height: 200px;
        overflow: auto;
        .list-container {
            display: flex;
            flex-wrap: wrap;
            .icon-item-wrapper {
                width: calc(100% / 3);
                height: 25px;
                line-height: 25px;
                cursor: pointer;
                display: flex;
                .icon-item {
                    display: flex;
                    max-width: 100%;
                    height: 100%;
                    padding: 0 5px;
                    &:hover {
                        background: #ececec;
                        border-radius: 5px;
                    }
                    .icon {
                        flex-shrink: 0;
                    }
                    span {
                        display: inline-block;
                        vertical-align: -0.15em;
                        fill: currentColor;
                        padding-left: 2px;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                }
                .icon-item.active {
                    background: #ececec;
                    border-radius: 5px;
                }
            }
        }
    }
}
</style>
```

### 3.4 操作菜单的接口

`src/api/menu/index.ts`

```ts
import request from '@/utils/request';

// 查询所有菜单
export function searchMenuList(data) {
    return request({
        url: 'sys/menu/list',
        method: "GET",
        params: data
    })
}

// 新增菜单
export function saveMenu(data) {
    return request({
        url: 'sys/menu',
        method: "POST",
        data: data
    })
}

// 修改菜单
export function updateMenu(data) {
    return request({
        url: 'sys/menu',
        method: "PUT",
        data: data
    })
}

// 查询菜单详情
export function searchMenuById(id) {
    return request({
        url: `sys/menu/${id}`,
        method: "GET"
    })
}

// 删除数据，传数组
export function removeMenu(ids) {
    return request({
        url: 'sys/menu',
        data: ids,
        method: "DELETE"
    })
}
```

## 4. 后端的菜单接口

### 4.1 分页查询所有菜单

- 分页参数实体类，包名`com.thuwsy.aoyou.common.request`

```java
@Data
public class PageParam implements Serializable {
    private Long pageNum = 1L;   // 第几页
    private Long pageSize = 10L; // 每页几条数据
}
```

- 封装分页查询结果的实体类，包名`com.thuwsy.aoyou.common.response`

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class CommonPageResult<T> implements Serializable {
    private List<T> list;
    private long total;
}
```

- 菜单查询的前端请求参数，包名`com.thuwsy.aoyou.common.domain.dto`

```java
@Data
public class UmsMenuParamDto extends PageParam {
    private String menuName;
    private String perms;
}
```

- controller层，在MenuController中添加方法

```java
    /**
     * 查询所有菜单
     */
    @GetMapping("/list")
    public CommonResult list(UmsMenuParamDto menuParamDto) {
        CommonPageResult<UmsMenu> pageResult = menuService.selectList(menuParamDto);
        return CommonResult.success(pageResult);
    }
```

- service层，在IUmsMenuService接口中添加方法

```java
CommonPageResult<UmsMenu> selectList(UmsMenuParamDto menuParamDto);
```

- service层，UmsMenuServiceImpl实现该方法

```java
    @Override
    public CommonPageResult<UmsMenu> selectList(UmsMenuParamDto menuParamDto) {
        LambdaQueryWrapper<UmsMenu> wrapper = new LambdaQueryWrapper<>();
        // 如果有搜索条件
        if (StrUtil.isNotBlank(menuParamDto.getMenuName()))
            wrapper.like(UmsMenu::getMenuName, menuParamDto.getMenuName());
        if (StrUtil.isNotBlank(menuParamDto.getPerms()))
            wrapper.like(UmsMenu::getPerms, menuParamDto.getPerms());
        // 注意，是对一级目录进行分页查询（子目录会折叠在一级目录下，无需分页）
        wrapper.eq(UmsMenu::getParentId, 0);

        // 进行分页查询
        Page<UmsMenu> page = new Page<>(menuParamDto.getPageNum(), menuParamDto.getPageSize());
        menuMapper.selectPage(page, wrapper);
        // 封装分页结果
        CommonPageResult<UmsMenu> parentMenuList = new CommonPageResult<>();
        parentMenuList.setList(page.getRecords());
        Collections.sort(parentMenuList.getList(), (item1, item2) -> {
            return item1.getSort() - item2.getSort();
        });
        parentMenuList.setTotal(page.getTotal());

        // 查询这些一级目录的所有子目录（由于我们一共只有两级目录，就不用递归了）
        List<Long> parentIds = parentMenuList.getList().stream()
                .map(UmsMenu::getId).toList();
        List<UmsMenu> childrenList = menuMapper.selectList(new LambdaQueryWrapper<UmsMenu>()
                .in(UmsMenu::getParentId, parentIds));

        // 给每个一级目录设置子目录
        for (int i = 0; i < parentMenuList.getList().size(); i++) {
            UmsMenu parent = parentMenuList.getList().get(i);
            List<UmsMenu> children = childrenList.stream()
                    .filter(item -> item.getParentId().equals(parent.getId()))
                    .sorted((item1, item2) -> {
                        return item1.getSort() - item2.getSort();
                    })
                    .toList();
            parent.setChildren(children);
        }
        return parentMenuList;
    }
```

### 4.2 后端校验

在common模块中添加权限校验的依赖：

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
```

修改UmsMenu实体类：

```java
@Data
@TableName("ums_menu")
public class UmsMenu implements Serializable {
    @TableId(type = IdType.AUTO)
    private Long id;
    @NotNull(message = "上级菜单不能为空")
    private Long parentId;
    @NotBlank(message = "菜单名称不能为空")
    private String menuName;
    private Integer sort;
    private Integer menuType;
    @NotBlank(message = "路由地址不能为空")
    private String path;
    @NotBlank(message = "组件名称不能为空")
    private String componentPath;
    @NotBlank(message = "权限标识不能为空")
    private String perms;
    @NotBlank(message = "菜单图标不能为空")
    private String icon;
    private Integer status;
    private String creator;
    @TableField(fill = FieldFill.INSERT)
    @JsonFormat(pattern="yyyy-MM-dd HH:mm:ss")
    private LocalDateTime createTime;
    private String updater;
    @TableField(fill = FieldFill.INSERT_UPDATE)
    @JsonFormat(pattern="yyyy-MM-dd HH:mm:ss")
    private LocalDateTime updateTime;
    private String remark;
    @TableLogic
    private Integer deleted;

    @TableField(exist = false)
    private List<UmsMenu> children = new ArrayList<>();
}
```

### 4.3 新增菜单接口

- MenuController中增加方法

```java
    /**
     * 新增菜单
     */
    @PostMapping
    public CommonResult saveMenu(@Valid @RequestBody UmsMenu umsMenu) {
        int row = menuService.saveMenu(umsMenu);
        if (row > 0)
            return CommonResult.success();
        return CommonResult.error("新增菜单失败");
    }
```

- IUmsMenuService中增加方法

```java
	int saveMenu(UmsMenu umsMenu);
```

- UmsMenuServiceImpl中实现该方法

```java
    @Transactional
    @Override
    public int saveMenu(UmsMenu umsMenu) {
        // 获取登录的用户名
        String creator = SecurityUtil.getUsername();
        // 设置该菜单的创建者和修改者
        umsMenu.setCreator(creator);
        umsMenu.setUpdater(creator);
        // 判断是否有重复菜单
        // 1. 同一级目录下，不能有同名的菜单
        // 2. 菜单的路由地址必须唯一
        Long parentId = umsMenu.getParentId();
        String menuName = umsMenu.getMenuName();
        String path = umsMenu.getPath();
        LambdaQueryWrapper<UmsMenu> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(UmsMenu::getParentId, parentId)
                .eq(UmsMenu::getMenuName, menuName)
                .or()
                .eq(UmsMenu::getPath, path);
        Long count = menuMapper.selectCount(wrapper);
        if (count > 0) {
            throw new ServiceException(HttpStatus.ERROR, "该菜单已存在");
        }
        return menuMapper.insert(umsMenu);
    }
```

### 4.4 修改菜单接口

- MenuController中增加方法

```java
    /**
     * 根据id查询菜单详情
     */
    @GetMapping("/{id}")
    public CommonResult searchInfo(@PathVariable("id") Long id) {
        UmsMenu menu = menuService.searchInfo(id);
        return CommonResult.success(menu);
    }

    /**
     * 修改菜单
     */
    @PutMapping
    public CommonResult updateMenu(@Valid @RequestBody UmsMenu umsMenu) {
        int row = menuService.updateMenu(umsMenu);
        if (row > 0) {
            return CommonResult.success();
        }
        return CommonResult.error("修改菜单失败");
    }
```

- IUmsMenuService中增加方法

```java
    UmsMenu searchInfo(Long id);
    int updateMenu(UmsMenu umsMenu);
```

- UmsMenuServiceImpl中实现方法

```java
    @Override
    public UmsMenu searchInfo(Long id) {
        return menuMapper.selectById(id);
    }

    @Transactional
    @Override
    public int updateMenu(UmsMenu umsMenu) {
        // 获取登录的用户名
        String updater = SecurityUtil.getUsername();
        // 设置该菜单的修改者
        umsMenu.setUpdater(updater);
        // 判断是否有重复菜单（除了当前修改的菜单自己）
        // 1. 同一级目录下，不能有同名的菜单
        // 2. 菜单的路由地址必须唯一
        Long parentId = umsMenu.getParentId();
        String menuName = umsMenu.getMenuName();
        String path = umsMenu.getPath();
        LambdaQueryWrapper<UmsMenu> wrapper = new LambdaQueryWrapper<>();
        wrapper.ne(UmsMenu::getId, umsMenu.getId())
                .and(w -> w.eq(UmsMenu::getParentId, parentId)
                        .eq(UmsMenu::getMenuName, menuName)
                        .or()
                        .eq(UmsMenu::getPath, path));
        Long count = menuMapper.selectCount(wrapper);
        if (count > 0) {
            throw new ServiceException(HttpStatus.ERROR, "该菜单已存在");
        }
        return menuMapper.updateById(umsMenu);
    }
```

### 4.5 删除菜单接口

> 删除菜单的业务逻辑，实际上还需要判断该目录下是否还有子菜单等约束条件，我们为了简化，省略这些约束逻辑，直接进行删除

- MenuController中增加方法

```java
    /**
     * 删除菜单
     */
    @DeleteMapping
    public CommonResult removeMenu(@RequestBody Long[] ids) {
        int row = menuService.removeMenu(ids);
        if (row > 0) {
            return CommonResult.success();
        }
        return CommonResult.error("删除菜单失败");
    }
```

- IUmsMenuService中增加方法

```java
    int removeMenu(Long[] ids);
```

- UmsMenuServiceImpl中实现方法

```java
    @Transactional
    @Override
    public int removeMenu(Long[] ids) {
        return menuMapper.deleteBatchIds(Arrays.asList(ids));
    }
```

# 第06章_项目部署

## 1. 服务器安装环境

- jdk
- docker
- nginx
- mysql（使用docker安装）
- redis（使用docker安装）

> 注意要将本地的mysql相关数据导出，然后上传到服务器执行sql文件

## 2. 后端项目打包部署

- 在父工程的pom文件中添加打包插件：

```xml
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.1</version>
                <configuration>
                    <source>${maven.compiler.source}</source>
                    <target>${maven.compiler.target}</target>
                    <encoding>${project.build.sourceEncoding}</encoding>
                </configuration>
            </plugin>
        </plugins>
    </build>

    <repositories>
        <repository>
            <id>public</id>
            <name>aliyun nexus</name>
            <url>https://maven.aliyun.com/repository/public</url>
            <releases>
                <enabled>true</enabled>
            </releases>
        </repository>
    </repositories>

    <pluginRepositories>
        <pluginRepository>
            <id>public</id>
            <name>aliyun nexus</name>
            <url>https://maven.aliyun.com/repository/public</url>
            <releases>
                <enabled>true</enabled>
            </releases>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </pluginRepository>
    </pluginRepositories>
```

- 修改starter模块的配置文件，将mysql和redis的ip地址都修改为`localhost`
- 在starter模块的pom文件中，添加打包插件和配置

```xml
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <version>3.1.5</version>
                <executions>
                    <execution>
                        <goals>
                            <goal>repackage</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-war-plugin</artifactId>
                <version>3.1.0</version>
                <configuration>
                    <failOnMissingWebXml>false</failOnMissingWebXml>
                    <warName>${project.artifactId}</warName>
                </configuration>
            </plugin>
        </plugins>
        <finalName>${project.artifactId}</finalName>
    </build>
```

- 在父工程目录，执行maven打包命令

```powershell
mvn clean package -Dmaven.test.skip=true
```

- 将starter模块的target目录下的jar包`aoyou-starter.jar`上传到服务器的`/wsy-app/aoyou-fast/`目录下
- 后台启动项目

```shell
nohup java -jar /wsy-app/aoyou-fast/aoyou-starter.jar > /wsy-app/aoyou-fast/logs/output.log 2>&1 &
```

## 3. 前端项目打包部署

- 因为需要Nginx转发，所以我们要修改前端请求后端接口的baseURL，我们修改`request.ts`中的如下内容

```ts
const request = axios.create({
    // 根请求地址
    // baseURL: 'http://127.0.0.1:8088/',
    baseURL: '/api/',
    withCredentials: false, // 用于配置请求接口跨域时是否需要凭证
    timeout: 30000 // 超时时间，单位ms
})
```

- 修改`vite.config.ts`，提高块大小的阈值

```ts
export default defineConfig({
  plugins: [
    ...
  ],
  resolve: {
    ...
  },
  build: {
    chunkSizeWarningLimit: 3000
  }
})
```

- 前端项目打包，在前端项目目录执行以下命令

```powershell
npm run build-only
```

- 前端项目打包好后，将dist目录上传到服务器的`/wsy-app/aoyou-fast/`目录下

> 注意：由于动态路由部署上线后容易找不到组件，所以我们将动态路由改成了静态路由：删除了路由守卫`src/router/permission.ts`文件，并在`src/router/index.ts`中添加静态路由。

## 4. Nginx配置

- 将nginx源配置文件拷贝一份，用于备份

```sh
cp /usr/local/nginx/conf/nginx.conf /usr/local/nginx/conf/nginx.conf.init
```

- 修改nginx配置文件

```sh
vi /usr/local/nginx/conf/nginx.conf
```

```
worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  localhost;

        #访问前端项目
        location / {
            root /wsy-app/aoyou-fast/dist;
            try_files $uri $uri/ /index.html;
            index index.html index.htm;
        }

        #接口请求转发
        location /api/ {
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header REMOTE-HOST $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://localhost:8088/;
        }
    }
}
```

- 然后重启nginx即可

